<!DOCTYPE html>
<html lang="ko">
<head>
    <script src="config/config.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìœµì¬ê¸ˆì§€êµ¬ì—­ íŒŒí‹° ì‹œë®¬ë ˆì´í„°</title>
    <link rel="icon" type="image/webp" href="images/smile_Ramona.webp">
    <link rel="stylesheet" href="css/common.css">

    <style>
        /* --- [ì „ì²´ CSS í†µí•©ë³¸: í…Œë§ˆ í†¤ì—… + ëª¨ë°”ì¼ ìµœì í™” ì ìš©] --- */
        :root {
            /* [ìˆ˜ì •] ë°°ê²½ í†¤ì—…: #121212 -> #1a1a1a */
            --bg-dark: #1a1a1a;
            /* [ìˆ˜ì •] ì‚¬ì´ë“œë°” í†¤ì—…: #0b0b0d -> #141414 */
            --sidebar-bg: #141414;
            /* [ìˆ˜ì •] ì¹´ë“œ ë°°ê²½ í†¤ì—…: #1a1a1d -> #252529 */
            --card-bg: #252529;
            --highlight: #f7a115;
            /* [ìˆ˜ì •] í…Œë‘ë¦¬ ê°€ì‹œì„± í™•ë³´: #444 -> #555 */
            --slot-border: #555;
            --text-main: #e6e6e6;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow: hidden; /* ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ìŠ¤í¬ë¡¤ ë°©ì§€ (ì•± ëŠë‚Œ) */
            font-family: 'Pretendard', sans-serif;
            margin: 0; padding: 0;
        }

        .builder-container {
            display: flex;
            height: 100vh;
            max-width: 1920px;
            margin: 0 auto;
        }

        /* --- [ì‚¬ì´ë“œë°”] --- */
        .sidebar {
            width: 80px;
            background-color: var(--sidebar-bg);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 120px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .team-tab {
            width: 44px; height: 44px;
            border-radius: 50%;
            border: 1px solid #444;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 25px;
            cursor: pointer;
            font-family: serif; font-size: 1.1em; color: #666;
            transition: all 0.2s;
            position: relative;
            background: transparent;
        }
        .team-tab:not(:last-child)::after {
            content: ''; position: absolute;
            bottom: -26px; width: 1px; height: 26px; background: #333;
        }
        .team-tab.active {
            border-color: var(--highlight);
            color: var(--highlight);
            box-shadow: 0 0 8px rgba(247, 161, 21, 0.2);
        }
        .team-tab.filled { border-color: #6a89cc; color: #a4b0be; }
        .team-tab.active.filled { border-color: var(--highlight); color: var(--highlight); }

        /* --- [ë©”ì¸ ë ˆì´ì•„ì›ƒ] --- */
        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px 50px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* 1. ìƒë‹¨ ë°± ë²„íŠ¼ */
        .back-btn-wrapper { margin-bottom: 20px; }
        .back-btn {
            display: inline-flex; align-items: center; padding: 8px 16px;
            background-color: #2e2e34;
            color: #ccc; text-decoration: none;
            border-radius: 4px; font-size: 0.9em; font-weight: bold;
            transition: all 0.2s; border: 1px solid #555; cursor: pointer;
        }
        .back-btn:hover { background-color: #3a3a40; color: #fff; border-color: #666; }

        /* 2. í—¤ë” ì˜ì—­ */
        .header-wrapper {
            border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 0;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-left h2 {
            margin: 0; font-family: serif; font-size: 2em; color: var(--highlight);
            display: flex; align-items: center; gap: 10px;
        }
        .edit-icon {
            cursor: pointer; opacity: 0.5; transition: 0.2s; width: 20px; height: 20px; margin-top: 5px;
        }
        .edit-icon:hover { opacity: 1; }
        .edit-icon path { fill: #fff; }

        /* 3. ì½˜í…ì¸  ì˜ì—­ */
        .content-row {
            flex: 1; display: flex; align-items: center; width: 100%; overflow: hidden;
        }
        /* 3-1. ì™¼ìª½ ë„ë©”ì¸ íŒ¨ë„ */
        .domain-side-panel {
            width: 220px; display: flex; flex-direction: row; align-items: center;
            justify-content: flex-start; flex-shrink: 0; padding-left: 10px;
            height: auto; align-self: flex-start; margin-top: 50px;
        }
        #team-domain-container { display: flex; align-items: center; gap: 15px; }
        .team-domain-circle {
            width: 64px; height: 64px; min-width: 64px;
            border-radius: 50%;
            background-color: #252529;
            border: 2px solid #666;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6); overflow: hidden; margin-bottom: 0;
        }
        .team-domain-img { width: 130%; height: 130%; object-fit: contain; }
        .domain-active-text {
            color: #bbb; font-family: 'Pretendard', sans-serif; font-size: 1.1em;
            font-weight: bold; letter-spacing: 0.5px; white-space: nowrap;
        }

        /* 3-2. ìŠ¬ë¡¯ ì»¨í…Œì´ë„ˆ */
        .slots-container {
            flex: 1; display: flex; gap: 40px; justify-content: flex-start;
            padding-left: 60px; align-items: center;
        }

        /* 4. í•˜ë‹¨ ë°” */
        .bottom-section {
            margin-top: auto; display: flex; justify-content: space-between; align-items: center;
            background: #252529;
            padding: 20px 30px; border-radius: 4px; border: 1px solid #444;
            flex-shrink: 0;
        }
        .silverkey-box { display: flex; align-items: center; gap: 15px; cursor: pointer; }
        .key-circle {
            width: 48px; height: 48px; border-radius: 50%; border: 1px solid #666;
            display: flex; justify-content: center; align-items: center;
            background: #222; overflow: hidden; color: #555; font-size: 1.5em; font-weight:100;
        }
        .key-circle img { width: 100%; height: 100%; object-fit: cover; }
        .key-info div:first-child { font-size: 0.8em; color: #888; margin-bottom: 3px; }
        .key-info div:last-child { font-size: 1em; color: #eee; font-weight: bold; }

        .btn-group { display: flex; gap: 10px; }
        .btn {
            padding: 10px 24px; border: none; border-radius: 2px;
            font-weight: bold; font-size: 0.95em; cursor: pointer;
            font-family: sans-serif; transition: 0.2s;
        }
        .btn:hover { filter: brightness(1.2); }
        .btn-blue { background: #5d8bb5; color: #fff; }
        .btn-yellow { background: var(--highlight); color: #111; }
        .btn-red { background: #c0392b; color: #fff; }
        .btn-sm { padding: 6px 14px; font-size: 0.85em; }

        /* --- [ìºë¦­í„° ì¹´ë“œ & íœ  ìŠ¬ë¡¯] --- */
        .char-card {
            width: 240px; aspect-ratio: 294 / 672;
            background-color: var(--card-bg); border: 1px solid var(--slot-border);
            position: relative; cursor: pointer; overflow: hidden;
            display: flex; flex-direction: column; justify-content: flex-end;
            transition: border-color 0.2s;
        }
        .char-card:hover { border-color: #777; }

        .char-card.empty {
            justify-content: center; align-items: center;
            background-color: #222226;
        }
        .empty-cross {
            width: 50px; height: 50px; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .empty-cross::before { content: ''; position: absolute; background: #444; width: 40px; height: 2px; }
        .empty-cross::after { content: ''; position: absolute; background: #444; width: 2px; height: 40px; }
        .empty-text { margin-top: 15px; color: #777; font-size: 1.1em; letter-spacing: -0.5px; }

        .char-tide-img {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: 0; transition: transform 0.3s;
        }
        .char-card:hover .char-tide-img { transform: scale(1.02); }

        .char-top-info {
            position: absolute; top: 0; left: 0; display: flex; align-items: center;
            background: linear-gradient(90deg, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.65) 85%, transparent 100%);
            padding: 8px 16px 8px 10px; z-index: 2; pointer-events: none;
        }
        .char-top-icon { width: 40px; height: 40px; margin-right: 10px; object-fit: contain; }
        .char-top-name {
            color: #fff; font-size: 1.3em; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.9); font-family: sans-serif;
        }

        .card-bottom-overlay {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 60%;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.7) 50%, transparent 100%);
            z-index: 1; pointer-events: none;
        }
        .wheels-wrapper {
            position: absolute; bottom: 30px; left: 0; right: 0;
            display: flex; justify-content: center; gap: 24px; z-index: 2; pointer-events: auto;
        }
        .slot-wheel {
            width: 84px; height: 130px; border: 1px solid #888; background: rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center;
            font-size: 2em; color: #555; cursor: pointer; transition: 0.2s;
        }
        .slot-wheel:hover { border-color: #fff; color: #fff; }
        .slot-wheel img { width: 100%; height: 100%; object-fit: cover; }

        .covenant-wrapper { position: absolute; bottom: 165px; right: 34px; z-index: 2; pointer-events: auto; }
        .slot-covenant {
            width: 64px; height: 74px; background: rgba(30, 30, 30, 0.8);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex; justify-content: center; align-items: center;
            color: #555; font-size: 1.8em; font-weight: 100; cursor: not-allowed;
        }
        .slot-covenant::after { content: '+'; }

        .card-conflict-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 10; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
        }
        .conflict-bar {
            width: 100%; padding: 8px 0; background: rgba(60, 60, 70, 0.95);
            border-top: 1px solid #aaa; border-bottom: 1px solid #aaa;
            color: #fff; font-size: 1.2em; font-weight: bold; text-align: center; font-family: serif;
        }

        /* --- [ëª¨ë‹¬ ê³µí†µ] --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }

        .modal-box {
            width: 90%; max-width: 900px; height: 85vh;
            background: #252529;
            border: 1px solid #555; display: flex; flex-direction: column;
        }
        .modal-box-wide {
            width: 95%; max-width: 1400px; height: 90vh;
            background: #252529;
            border: 1px solid #555; display: flex; flex-direction: row;
        }
        .modal-header {
            padding: 15px 20px;
            background: #2e2e34;
            border-bottom: 1px solid #444;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-header h3 { margin: 0; color: #eee; font-size: 1.1em; }
        .close-btn { background: none; border: none; color: #999; font-size: 1.5em; cursor: pointer; }

        /* í•„í„° ì»¨í…Œì´ë„ˆ */
        .char-filter-container {
            padding: 12px 20px;
            background: #2a2a2e;
            border-bottom: 1px solid #444;
            display: flex; flex-wrap: wrap; gap: 20px;
        }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-label { color: #888; font-size: 0.85em; font-weight: bold; margin-right: 5px; }
        .filter-chip {
            padding: 6px 12px; border-radius: 20px; border: 1px solid #444;
            background: #2a2a30; color: #ccc; font-size: 0.85em; cursor: pointer; transition: 0.2s;
        }
        .filter-chip:hover { background: #3a3a40; border-color: #666; }
        .filter-chip.active {
            background: rgba(247, 161, 21, 0.15); border-color: var(--highlight); color: var(--highlight); font-weight: bold;
        }

        /* ëª¨ë‹¬ ë‚´ë¶€ ì½˜í…ì¸  */
        .wheel-list-wrapper { flex: 1; display: flex; flex-direction: column; border-right: 1px solid #333; }
        .wheel-list-panel { flex: 1; overflow-y: auto; padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; align-content: start; }
        .wheel-equip-panel {
            width: 400px; padding: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #1e1e22;
            flex-shrink: 0;
        }
        .wheel-equip-slots { display: flex; gap: 30px; margin-bottom: 40px; }

        .large-slot {
            width: 140px; height: 240px; border: 2px solid #555; background: #222;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative; transition: all 0.2s;
        }
        .large-slot:hover { border-color: #888; }
        .large-slot.active { border-color: var(--highlight); box-shadow: 0 0 15px rgba(247, 161, 21, 0.3); }
        .large-slot img { width: 100%; height: 100%; object-fit: cover; }
        .slot-placeholder { font-size: 4em; color: #444; font-weight: 100; }
        .slot-desc { margin-top: 10px; color: #777; font-size: 0.9em; }

        .modal-grid {
            flex: 1; overflow-y: auto; padding: 20px;
            display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 8px; align-content: start;
        }
        .modal-footer {
            padding: 15px 20px;
            background: #2e2e34;
            border-top: 1px solid #444; text-align: right;
        }

        .grid-item {
            position: relative; aspect-ratio: 1/1;
            background: #333338;
            cursor: pointer; border: 2px solid transparent;
        }
        .grid-item-wheel { aspect-ratio: 3/4; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .grid-item.selected { border-color: var(--highlight); }
        .grid-item.selected::after { content: 'âœ”'; position: absolute; top: 0; right: 0; background: var(--highlight); color: #000; font-size: 0.8em; padding: 2px 4px; }
        .grid-item.disabled { pointer-events: none; filter: grayscale(100%) brightness(0.4); }
        .grid-item.conflict { pointer-events: none; border: 1px solid #e74c3c; }
        .grid-item.conflict img { opacity: 0.3; }
        .grid-item.conflict::before { content: 'ì˜ì—­ ì¶©ëŒ'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #e74c3c; font-size: 0.7em; font-weight: bold; white-space: nowrap; z-index: 5; }

        .item-tooltip { display: none; position: fixed; z-index: 9999; background: rgba(18, 18, 18, 0.95); border: 1px solid #777; border-radius: 4px; padding: 12px; max-width: 300px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); pointer-events: none; color: #eee; font-size: 0.9rem; line-height: 1.4; }
        .tooltip-title { color: var(--highlight); font-weight: bold; margin-bottom: 6px; font-size: 1.1em; border-bottom: 1px solid #444; padding-bottom: 4px; }
        .tooltip-desc { color: #ccc; word-break: keep-all; }
        .tooltip-tags { margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px; }
        .tooltip-tag { font-size: 0.75em; background: #333; color: #aaa; padding: 2px 6px; border-radius: 4px; }

        /* --- [ê²€ìƒ‰ì°½ ë° ë“œë¡­ë‹¤ìš´] --- */
        .search-container {
            padding: 15px 20px;
            border-bottom: 1px solid #444;
            background: #2a2a2e;
            z-index: 20;
            position: relative;
            height: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .search-icon-svg { position: absolute; left: 12px; width: 18px; height: 18px; fill: #777; transition: fill 0.2s; pointer-events: none; }
        .search-input-wrapper { position: relative; width: 100%; display: flex; align-items: center; }
        #wheel-search-input, #key-search-input {
            width: 100%; padding: 12px 15px 12px 40px;
            background: #1e1e22;
            border: 1px solid #555; color: #eee; border-radius: 4px; font-size: 1em; outline: none; transition: all 0.2s; font-family: 'Pretendard', sans-serif;
        }
        #wheel-search-input:focus, #key-search-input:focus { border-color: var(--highlight); background: #000; box-shadow: 0 0 8px rgba(247, 161, 21, 0.15); }
        .search-input-wrapper:focus-within .search-icon-svg { fill: var(--highlight); }

        .suggestions-dropdown {
            position: relative;
            width: 100%;
            background: #333338;
            border: 1px solid #555;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            display: none;
            z-index: 100;
            margin-top: -1px;
            animation: expandDropdown 0.2s ease-out;
        }
        .suggestion-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #333; color: #ccc; font-size: 0.9em; }
        .suggestion-item:hover { background: var(--highlight); color: #000; }
        .suggestion-match { color: var(--highlight); font-weight: bold; }
        .suggestion-item:hover .suggestion-match { color: #000; }
        .active-tags-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; min-height: 5px; }
        .active-tag-chip { background: rgba(247, 161, 21, 0.2); border: 1px solid var(--highlight); color: var(--highlight); padding: 4px 10px; border-radius: 15px; font-size: 0.85em; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .active-tag-chip:hover { background: rgba(247, 161, 21, 0.4); }
        .active-tag-chip::after { content: 'Ã—'; font-weight: bold; font-size: 1.1em; }
        .no-result-message { grid-column: 1 / -1 !important; width: 100%; text-align: center; color: #777; padding: 60px 0; font-size: 1.1em; display: flex; flex-direction: column; align-items: center; justify-content: center; white-space: nowrap; }
        .no-result-message::before { content: 'ğŸ”'; font-size: 2em; opacity: 0.5; margin-bottom: 5px; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes expandDropdown {
            from { max-height: 0; opacity: 0; }
            to { max-height: 200px; opacity: 1; }
        }

        /* --- [ëª¨ë°”ì¼/íƒœë¸”ë¦¿ ë°˜ì‘í˜• ì²˜ë¦¬] --- */
        /* íƒœë¸”ë¦¿/ì†Œí˜• ë…¸íŠ¸ë¶ ëŒ€ì‘ (1024px ì´í•˜) */
        @media (max-width: 1024px) {
            .modal-box-wide {
                flex-direction: column;
                width: 95%;
                height: 90vh;
            }
            .wheel-list-wrapper {
                border-right: none;
                border-bottom: 1px solid #444;
                height: 55%;
                display: flex;
                flex-direction: column;
            }
            .wheel-list-panel {
                flex: 1;
                min-height: 0;
            }
            .wheel-equip-panel {
                width: 100%;
                height: 45%;
                padding: 15px;
            }
            .large-slot { width: 100px; height: 160px; }
            .wheel-equip-slots { gap: 15px; margin-bottom: 15px; }
        }

        /* ëª¨ë°”ì¼ ëŒ€ì‘ (768px ì´í•˜) */
        @media (max-width: 768px) {
            /* 1. ì „ì²´ ë ˆì´ì•„ì›ƒ: ì„¸ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© & ë·°í¬íŠ¸ ë³´ì • */
            body { overflow-y: auto; }
            .builder-container {
                flex-direction: column;
                height: auto;
                min-height: 100dvh; /* dvh: ëª¨ë°”ì¼ ë¸Œë¼ìš°ì €ë°” ëŒ€ì‘ ë™ì  ë†’ì´ */
            }

            /* 2. ì‚¬ì´ë“œë°” (ìƒë‹¨ ìŠ¤í¬ë¡¤ íƒ­) */
            .sidebar {
                width: 100%; height: 55px;
                flex-direction: row; padding: 0;
                border-right: none; border-bottom: 1px solid #333;
                justify-content: flex-start; overflow-x: auto; white-space: nowrap;
                background: var(--sidebar-bg);
            }
            .team-tab { margin: 0 5px; width: 40px; height: 40px; flex-shrink: 0; border: none; border-radius: 4px; }
            .team-tab:not(:last-child)::after { display: none; }
            .team-tab.active { background: #333; border: 1px solid var(--highlight); }

            /* 3. ë©”ì¸ ì˜ì—­ */
            .main-area { padding: 15px; height: auto; overflow: visible; padding-bottom: 100px; /* í•˜ë‹¨ë°” ê°€ë¦¼ ë°©ì§€ ì—¬ë°± */ }
            .header-left h2 { font-size: 1.4em; }
            .btn-sm { padding: 6px 10px; font-size: 0.8em; }

            /* 4. ì½˜í…ì¸  ì •ë ¬ (ì„¸ë¡œ ë°°ì¹˜) */
            .content-row { flex-direction: column; height: auto; gap: 20px; }
            .domain-side-panel { width: 100%; height: auto; margin: 0; padding: 0; justify-content: center; }

            /* 5. ìºë¦­í„° ìŠ¬ë¡¯ (2x2 ê·¸ë¦¬ë“œ) */
            .slots-container {
                display: grid; grid-template-columns: 1fr 1fr; gap: 10px;
                padding: 0; width: 100%;
            }
            .char-card { width: 100%; aspect-ratio: 3/5; }
            .char-top-name { font-size: 1em; }
            .char-top-icon { width: 20px; height: 20px; }
            .slot-wheel { width: 36px; height: 54px; font-size: 1.2em; }
            .slot-covenant { width: 36px; height: 45px; font-size: 1.2em; bottom: 70px; right: 5px; }
            .wheels-wrapper { gap: 8px; bottom: 10px; }
            .empty-cross { width: 30px; height: 30px; }
            .empty-text { font-size: 0.9em; }

            /* 6. í•˜ë‹¨ ë°” (Sticky Footer) */
            .bottom-section {
                position: fixed; bottom: 0; left: 0; width: 100%;
                background: rgba(37, 37, 41, 0.98); border-top: 1px solid #555;
                flex-direction: row; padding: 10px 15px; box-sizing: border-box;
                z-index: 50; gap: 10px;
            }
            .silverkey-box { flex: 1; }
            .key-circle { width: 36px; height: 36px; font-size: 1.2em; }
            .key-info div:last-child { font-size: 0.9em; }
            .btn-group { gap: 8px; }
            .btn { padding: 8px 12px; font-size: 0.85em; white-space: nowrap; }

            /* --- [í•µì‹¬ ìˆ˜ì •: ëª¨ë°”ì¼ ëª¨ë‹¬ ë ˆì´ì•„ì›ƒ] --- */
            /* ëª¨ë‹¬ ë°•ìŠ¤ë¥¼ í™”ë©´ ê°€ë“ ì±„ìš°ë˜, Flex Columnìœ¼ë¡œ ë‚´ë¶€ ì˜ì—­ ë¶„ë°° */
            .modal-box, .modal-box-wide {
                width: 100%; height: 100dvh; /* í™”ë©´ ê½‰ ì±„ì›€ */
                max-width: none; max-height: none;
                border: none; border-radius: 0;
                display: flex; flex-direction: column; /* ì„¸ë¡œ ë°°ì¹˜ ê°•ì œ */
                background: #1e1e22; /* ë°°ê²½ìƒ‰ í™•ì‹¤í•˜ê²Œ */
            }

            /* í—¤ë”ì™€ í‘¸í„°ëŠ” ê³ ì • ë†’ì´ ìœ ì§€ */
            .modal-header { flex-shrink: 0; padding: 12px 15px; }
            .modal-footer { flex-shrink: 0; padding: 12px 15px; }

            /* ì€ì—´ì‡ /ìºë¦­í„° ëª¨ë‹¬ ê·¸ë¦¬ë“œ: ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ + ìŠ¤í¬ë¡¤ */
            .modal-grid {
                flex: 1;
                overflow-y: auto;
                padding: 15px;
                gap: 8px;
                height: auto; /* ë†’ì´ ìë™ ê³„ì‚° */
            }

            /* ëª…ë¥œ(íœ ) ëª¨ë‹¬ íŠ¹ìˆ˜ ë ˆì´ì•„ì›ƒ: ìƒí•˜ ë¶„í•  */
            .wheel-list-wrapper {
                flex: 1; /* ìƒë‹¨ ëª©ë¡ì´ ë‚¨ì€ ê³µê°„ì˜ 60% ì •ë„ ì°¨ì§€í•˜ë„ë¡ ìœ ë™ì  ì„¤ì •ì´ ì¢‹ìœ¼ë‚˜, ëª¨ë°”ì¼ì€ flex:1ë¡œ ë°€ì–´ë„£ìŒ */
                height: 60%; /* ê°•ì œ ë†’ì´ ë°°ë¶„ (ëª©ë¡ ì˜ì—­) */
                border-right: none;
                border-bottom: 1px solid #444;
                display: flex; flex-direction: column;
            }
            .wheel-list-panel { flex: 1; overflow-y: auto; padding: 15px; min-height: 0; }

            .wheel-equip-panel {
                width: 100%;
                height: 40%; /* í•˜ë‹¨ ì¥ì°© ì˜ì—­ (ê³ ì • ë¹„ìœ¨) */
                flex-shrink: 0;
                padding: 10px;
                display: flex; flex-direction: column; justify-content: center;
                background: #151518;
            }

            /* ì¥ì°© ìŠ¬ë¡¯ í¬ê¸° ì¡°ì • */
            .wheel-equip-slots { gap: 15px; margin-bottom: 10px; justify-content: center; }
            .large-slot { width: 80px; height: 130px; } /* ë” ì‘ê²Œ ì¡°ì • */
            .slot-placeholder { font-size: 2.5em; }
            .equip-info-text { font-size: 0.85em; margin-bottom: 10px; min-height: auto; }

            /* ëª¨ë‹¬ ë‚´ë¶€ ë²„íŠ¼ í¬ê¸° ìµœì í™” */
            .wheel-equip-panel .btn { width: 100%; margin-top: 5px; padding: 8px; }

            /* í•„í„° ê°€ë¡œ ìŠ¤í¬ë¡¤ */
            .char-filter-container { gap: 8px; padding: 10px; overflow-x: auto; flex-wrap: nowrap; flex-shrink: 0; }
            .filter-group { flex-shrink: 0; border-left: 1px solid #444 !important; padding-left: 10px !important; }
            .filter-group:first-child { border-left: none !important; padding-left: 0 !important; }

            /* [ì‹ ê·œ] ëª¨ë°”ì¼ ì „ìš© íˆ´íŒ ìŠ¤íƒ€ì¼ (í™”ë©´ í•˜ë‹¨ ê³ ì • íŒ¨ë„) */
            .item-tooltip {
                position: fixed !important; /* JSì˜ top/left ì¢Œí‘œ ë¬´ì‹œ */
                top: auto !important;       /* ìƒë‹¨ ìœ„ì¹˜ ì´ˆê¸°í™” */
                bottom: 90px !important;    /* í•˜ë‹¨ ë²„íŠ¼ë“¤ ë°”ë¡œ ìœ„ì— ìœ„ì¹˜ */
                left: 50% !important;       /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ ì‹œì‘ì  */
                transform: translateX(-50%) !important; /* ì •í™•í•œ ì¤‘ì•™ ì •ë ¬ */

                width: 90% !important;      /* í™”ë©´ ê½‰ ì°¨ê²Œ */
                max-width: none !important;

                background: rgba(25, 25, 30, 0.98); /* ê°€ë…ì„±ì„ ìœ„í•´ ë°°ê²½ ë¶ˆíˆ¬ëª…ë„ ë†’ì„ */
                border: 1px solid var(--highlight); /* ê°•ì¡°ìƒ‰ í…Œë‘ë¦¬ */
                box-shadow: 0 -5px 20px rgba(0,0,0,0.7); /* ê·¸ë¦¼ìë¡œ íŒì—… ëŠë‚Œ ê°•ì¡° */

                /* í…ìŠ¤íŠ¸ ì •ë ¬ ë° ìŠ¤íƒ€ì¼ */
                text-align: left;
                padding: 15px;
                z-index: 2000; /* ëª¨ë‹¬ë³´ë‹¤ ë” ìœ„ì— ëœ¨ë„ë¡ */
                border-radius: 8px;
                pointer-events: none; /* í„°ì¹˜ í†µê³¼ (ë²„íŠ¼ ëˆ„ë¥´ê¸° ë°©í•´ ì•ˆ ë˜ê²Œ) */
            }

            /* íˆ´íŒ ë‚´ë¶€ í…ìŠ¤íŠ¸ í¬ê¸° ì¡°ì • */
            .tooltip-title { font-size: 1.1em; margin-bottom: 8px; }
            .tooltip-desc { font-size: 0.9em; line-height: 1.5; color: #ddd; }
            .tooltip-tag { padding: 3px 8px; font-size: 0.8em; }
        }
        /* ============================================================
       [ê¸´ê¸‰ ì´ì‹] components.css & common.css ì›ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
       ============================================================ */

        /* 1. í”Œë¡œíŒ… ë²„íŠ¼ (common.css ì›ë³¸) */
        .floating-report-btn {
            position: fixed;
            right: 20px;
            top: 50%; /* í™”ë©´ ì¤‘ì•™ ì •ë ¬ */
            transform: translateY(-50%);
            z-index: 2000; /* íŒŒí‹° ë¹Œë”ì˜ ìš”ì†Œë“¤ë³´ë‹¤ ìœ„ì— ì˜¤ë„ë¡ z-indexë§Œ ìƒí–¥ ì¡°ì • */
            background: #3a3a3a;
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        .floating-report-btn:hover {
            background: #4a4a4a;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        /* 2. ëª¨ë‹¬ ì»¨í…ì¸  (components.css ì›ë³¸) */
        /* ì£¼ì˜: íŒŒí‹°ë¹Œë”ì˜ .modal-box ëŒ€ì‹  links.htmlê³¼ ë˜‘ê°™ì€ .modal-content ì‚¬ìš© */
        #report-modal .modal-content {
            width: 90%;
            max-width: 500px;
            background-color: #222; /* ì›ë³¸ ë‹¤í¬ ê·¸ë ˆì´ */
            border-radius: 12px;
            padding: 20px;
            border: 1px solid #444;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            text-align: left;
            color: #eee;
        }

        /* 3. í¼ ìŠ¤íƒ€ì¼ (components.css ì›ë³¸) */
        #report-modal .form-title {
            color: #ffc107;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.5em; /* h2 ì‚¬ì´ì¦ˆ ë³´ì • */
        }
        #report-modal p { color: #aaa; font-size: 0.9em; margin-bottom: 15px; }

        #report-modal .form-field-label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ccc;
            font-size: 1em;
        }

        #report-modal .form-input,
        #report-modal .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #555;
            border-radius: 6px;
            background-color: #383838;
            color: #eee;
            font-size: 1em;
            box-sizing: border-box;
            font-family: 'Pretendard', sans-serif;
        }
        #report-modal .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        #report-modal .form-input:focus,
        #report-modal .form-textarea:focus {
            outline: none;
            border-color: #ffc107;
        }

        #report-modal .form-submit-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: #007bff; /* ì›ë³¸ íŒŒë€ìƒ‰ */
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 1em;
        }
        #report-modal .form-submit-btn:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

<div class="builder-container">
    <div class="sidebar" id="sidebar-tabs"></div>
    <div class="main-area">
        <div class="back-btn-wrapper">
            <a href="javascript:void(0);" onclick="goBackToMenu()" class="back-btn">â¬… ìœµì¬ê¸ˆêµ¬ ë©”ë‰´ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <div class="header-wrapper">
            <div class="header-left">
                <h2 id="team-title-text">TEAM I</h2>
                <svg class="edit-icon" onclick="editTeamName()" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" />
                </svg>
            </div>
            <button class="btn btn-red btn-sm" onclick="resetCurrentTeam()">íŒ€ ì´ˆê¸°í™”</button>
        </div>

        <div class="content-row">
            <div class="domain-side-panel">
                <div id="team-domain-container">
                </div>
            </div>

            <div class="slots-container" id="team-slots"></div>
        </div>

        <div class="bottom-section">
            <div class="silverkey-box" onclick="openKeyModal()">
                <div class="key-circle" id="key-icon">+</div>
                <div class="key-info">
                    <div>ì€ì—´ì‡ </div>
                    <div id="key-name">ì¥ì°© ì•ˆ í•¨</div>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn btn-blue" onclick="openQuickSetup()">ë¹ ë¥¸ í¸ì„±</button>
                <button class="btn btn-yellow" onclick="saveAllData()">ì €ì¥</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-char" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ë°°ì¹˜í•  ê°ì„±ì²´ ì„ íƒ (ìµœëŒ€ 4ëª…)</h3>
            <button class="close-btn" onclick="closeModal('modal-char')">&times;</button>
        </div>

        <div class="char-filter-container">
            <div class="filter-group">
                <span class="filter-label">ì˜ì—­:</span>
                <div class="filter-chip" onclick="toggleCharFilter('domain', 'chaos')">í˜¼ëˆ</div>
                <div class="filter-chip" onclick="toggleCharFilter('domain', 'aequor')">ì‹¬í•´</div>
                <div class="filter-chip" onclick="toggleCharFilter('domain', 'caro')">í˜ˆìœ¡</div>
                <div class="filter-chip" onclick="toggleCharFilter('domain', 'ultra')">ì´ˆì°¨ì›</div>
            </div>
            <div class="filter-group" style="border-left:1px solid #444; padding-left:20px;">
                <span class="filter-label">ì—­í• :</span>
                <div class="filter-chip" onclick="toggleCharFilter('class', 'assault')">ë°ë¯¸ì§€í˜•</div>
                <div class="filter-chip" onclick="toggleCharFilter('class', 'warden')">ë°©ì–´í˜•</div>
                <div class="filter-chip" onclick="toggleCharFilter('class', 'chorus')">ë³´ì¡°í˜•</div>
            </div>
        </div>

        <div class="modal-grid" id="grid-char"></div>
        <div class="modal-footer">
            <span id="char-count" style="color:#aaa; margin-right:15px; font-size:0.9em;">0 / 4 ì„ íƒë¨</span>
            <button class="btn btn-yellow" onclick="confirmQuickSetup()">ë°°ì¹˜ í™•ì •</button>
        </div>
    </div>
</div>

<div id="modal-wheel" class="modal-overlay">
    <div class="modal-box-wide">
        <div class="wheel-list-wrapper">
            <div class="search-container">
                <div class="search-input-box">
                    <div class="search-input-wrapper">
                        <svg class="search-icon-svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                        <input type="text" id="wheel-search-input" placeholder="íƒœê·¸ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." autocomplete="off">
                    </div>
                    <div id="search-suggestions" class="suggestions-dropdown"></div>
                </div>
                <div id="active-tags-area" class="active-tags-list"></div>
            </div>
            <div class="wheel-list-panel" id="grid-wheel"></div>
        </div>
        <div class="wheel-equip-panel">
            <h3 style="color:#eee; margin-bottom:20px;">ì¥ì°© ìŠ¬ë¡¯ ì„ íƒ</h3>
            <div class="wheel-equip-slots">
                <div class="large-slot" id="equip-slot-0" onclick="selectWheelSlot(0)"><div class="slot-placeholder">+</div></div>
                <div class="large-slot" id="equip-slot-1" onclick="selectWheelSlot(1)"><div class="slot-placeholder">+</div></div>
            </div>
            <div class="equip-info-text" id="equip-slot-desc" style="color:#777; margin-bottom:20px; text-align:center; min-height:40px;">ìŠ¬ë¡¯ì„ ì„ íƒí•˜ê³  ì¢Œì¸¡ ëª©ë¡ì—ì„œ ëª…ë¥œì„ í´ë¦­í•˜ì„¸ìš”.</div>
            <button class="btn btn-red" onclick="unequipSelectedWheel()">í•´ì œ</button>
            <button class="btn btn-blue" onclick="closeModal('modal-wheel')" style="margin-top:15px; width: 100px;">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="modal-key" class="modal-overlay">
    <div class="modal-box" style="max-width:600px; height:80vh;">
        <div class="modal-header"><h3>ì€ì—´ì‡  ì„ íƒ</h3><button class="close-btn" onclick="closeModal('modal-key')">&times;</button></div>
        <div class="search-container">
            <div class="search-input-box">
                <div class="search-input-wrapper">
                    <svg class="search-icon-svg" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                    <input type="text" id="key-search-input" placeholder="íƒœê·¸ ë˜ëŠ” ì´ë¦„ ê²€ìƒ‰..." autocomplete="off">
                </div>
                <div id="key-search-suggestions" class="suggestions-dropdown"></div>
            </div>
            <div id="active-key-tags-area" class="active-tags-list"></div>
        </div>
        <div class="modal-grid" id="grid-key"></div>
        <div class="modal-footer">
            <button class="btn btn-red" onclick="unequipKey()" style="margin-right:10px;">í•´ì œ</button>
            <button class="btn btn-blue" onclick="closeModal('modal-key')">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="global-tooltip" class="item-tooltip">
    <div class="tooltip-title" id="tt-title"></div>
    <div class="tooltip-desc" id="tt-desc"></div>
    <div class="tooltip-tags" id="tt-tags"></div>
</div>

<div id="modal-system" class="modal-overlay">
    <div class="modal-box" style="max-width: 450px; height: auto; min-height: 200px; border-color: #777;">
        <div class="modal-header">
            <h3 id="sys-modal-title" style="color: var(--highlight);">ì•Œë¦¼</h3>
            <button class="close-btn" onclick="closeModal('modal-system')">&times;</button>
        </div>
        <div style="padding: 40px 30px; text-align: center; color: #e0e0e0; font-size: 1.1em; line-height: 1.5; white-space: pre-line;" id="sys-modal-msg">
            ë‚´ìš©
        </div>
        <div class="modal-footer" style="justify-content: center; gap: 15px; padding-bottom: 25px;">
            <button id="sys-btn-yes" class="btn btn-yellow" style="min-width: 80px;">í™•ì¸</button>
            <button id="sys-btn-no" class="btn btn-red" style="min-width: 80px; display: none;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<script>
    const MAX_TEAMS = 10;
    const ROMAN_NUMS = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII", "IX", "X"];

    // [ì‹ ê·œ] í•„í„° ìƒíƒœ ê´€ë¦¬ ë³€ìˆ˜
    let activeCharFilters = {
        domain: new Set(),
        class: new Set()
    };

    const ALL_KEY_TAGS = [ "ì‚°ì¶œë ¥", "ì‚°ì¶œë ¥ íšë“", "ì€ì—´ì‡  ì—ë„ˆì§€", "ì€ì—´ì‡  ê²Œì´ì§€", "ë°©ì–´ë§‰ íšë“", "ì²´ë ¥ íšŒë³µ", "í˜", "í˜ ì¦ê°€", "í”¼í•´ ì¦í­", "ì¹˜ëª…íƒ€ í™•ë¥ ", "ì¹˜ëª…íƒ€ í™•ë¥  ì¦ê°€", "ì¹˜ëª…íƒ€ í”¼í•´", "ì¹˜ëª…íƒ€ í”¼í•´ ì¦ê°€", "ì˜ì—­ ìˆ™ë ¨", "ì¹´ë“œ ì¶”ê°€", "ë“œë¡œìš°", "ì¹´ë“œ ë½‘ê¸°", "ì½”ìŠ¤íŠ¸ ê°ì†Œ", "ê³„ì‚° ë¹„ìš©", "ë³µì‚¬ë³¸", "ì˜ê°", "ê´‘ê¸°", "ê´‘ê¸° ë¶€ì—¬", "ì•½í™”", "ì·¨ì•½", "ì¤‘ë…", "ì¤‘ë… ë¶€ì—¬", "í˜ í›”ì¹¨", "í˜ ê°ì†Œ", "ë°˜ê²©", "ì†Œë©¸", "ê²½ê³„", "í¬ìƒ", "í„°ì¹˜ì›”", "í„°ì¹˜ ì†ìƒ", "ì¶œìƒ ì˜ì‹", "ìŠ¤ì¹¼ë › ìš©ê´‘ë¡œ", "ì´ˆì›” í„´", "ì‹œí¸", "ì£¼ì‚¬ìœ„" ];
    let activeKeyTags = new Set();

    const ALL_SEARCH_TAGS = [ "ì€ì—´ì‡  ì¶©ì „", "í”¼í•´ ì¦í­", "ì˜ì—­ ìˆ™ë ¨", "ì£½ìŒ ì €í•­", "ê´‘ê¸° íšŒë³µ", "ê²€ì€ ì¸ì¥ ë“œë¡­ìœ¨", "í¬ë¦¬í‹°ì»¬ í™•ë¥ ", "í¬ë¦¬í‹°ì»¬ í”¼í•´", "ê¸°ë³¸ í”¼í•´ ì¦ê°€", "ìµœì¢… í”¼í•´ ì¦ê°€", "ëŠ¥ë™ í”¼í•´ ì¦ê°€", "í˜", "ì„ì‹œ í˜", "ë°˜ê²©", "ë°©ì–´ë§‰", "HP íšŒë³µ", "ê´‘ê¸° íšë“", "ì€ì—´ì‡  ì—ë„ˆì§€", "ì‚°ì¶œë ¥", "ì†íŒ¨ ìƒí•œ", "ì¹´ë“œ ë½‘ê¸°", "ì¤‘ë…", "ì·¨ì•½", "í—ˆì•½", "ì „íˆ¬ ì‹œì‘ ì‹œ", "í„´ ì‹œì‘ ì‹œ", "ê´‘ê¸° í­ë°œ", "ì€ì—´ì‡  ë°œë™", "ëª…ë ¹ ì¹´ë“œ", "íƒ€ê²©", "ë°©ì–´", "ì  ì²˜ì¹˜", "í”¼ê²©", "í˜ˆìœ¡", "ì‹¬í•´", "ì´ˆì°¨ì›", "ë°°ì•„", "ì´‰ìˆ˜", "í•ë¹› ìš©ê´‘ë¡œ", "ì‹¬ì¥ì˜ ë¶ˆ", "ë¹™ì„¤", "í•™ì ì¸ê²©", "ê´‘ëŒ€ ì¸ê²©", "ê³ ìš”í•œ ë°”ë‹¤", "ëª°ì•„ì¹˜ëŠ” íŒŒë„", "ì €ì£¼ë°›ì€ ìœ ë¬¼", "ì¦ìƒ ì¹´ë“œ" ];
    let activeWheelTags = new Set();

    let teams = Array.from({ length: MAX_TEAMS }, (_, i) => ({
        name: `TEAM ${ROMAN_NUMS[i]}`,
        chars: [null, null, null, null],
        wheels: [ [null, null], [null, null], [null, null], [null, null] ],
        key: null
    }));
    let currentTeamIdx = 0;
    let DB = { chars: [], wheels: [], keys: [] };
    let tempChars = [];
    let editingCharIdx = -1;
    let selectedWheelSlotIdx = 0;

    document.addEventListener('DOMContentLoaded', async () => {
        await loadExternalData();
        assignTagsToWheels();
        assignTagsToKeys();
        loadFromLocalStorage();
        renderAll();
    });

    function goBackToMenu() {
        if (document.referrer && document.referrer.includes('links.html')) {
            history.back();
        } else {
            location.href = 'links.html?category=weapon';
        }
    }

    function resetCurrentTeam() {
        // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ í˜¸ì¶œ
        openSystemConfirm(
            "íŒ€ ì´ˆê¸°í™”",
            `[${teams[currentTeamIdx].name}] íŒ€ ì„¤ì •ì„ ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
            () => {
                // 1. ë°ì´í„° ì´ˆê¸°í™”
                teams[currentTeamIdx].chars = [null, null, null, null];
                teams[currentTeamIdx].wheels = [ [null, null], [null, null], [null, null], [null, null] ];
                teams[currentTeamIdx].key = null;

                // 2. í™”ë©´ ê°±ì‹ 
                renderAll();

                // 3. â˜…ìë™ ì €ì¥â˜… (ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ)
                saveAllData(true);

                // 4. ì™„ë£Œ ì•Œë¦¼ (ì„ íƒ ì‚¬í•­ - í•„ìš” ì—†ìœ¼ë©´ ì§€ì›Œë„ ë¨)
                // openSystemAlert("ì´ˆê¸°í™” ì™„ë£Œ", "íŒ€ ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        );
    }

    function assignTagsToKeys() {
        if(!DB.keys) return;
        DB.keys.forEach(key => {
            const jsonTags = key.tags || [];
            const combinedTags = new Set(jsonTags);
            const text = (key.description + " " + key.korean_name).replace(/\s+/g, '');
            ALL_KEY_TAGS.forEach(keyword => {
                const cleanKeyword = keyword.replace(/\s+/g, '');
                if (text.includes(cleanKeyword)) combinedTags.add(keyword);
            });
            if(key.korean_name === "ì¥ì˜ ì§€í˜œ") combinedTags.add("ì‚°ì¶œë ¥");
            key.tags = Array.from(combinedTags);
        });
    }

    async function loadExternalData() {
        try {
            const ts = new Date().getTime();
            const [resChars, resWheels, resKeys] = await Promise.all([
                fetch(`data/character_manifest.json?t=${ts}`),
                fetch(`data/wheel_list.json?t=${ts}`),
                fetch(`data/silverkey_list.json?t=${ts}`)
            ]);
            if (!resChars.ok || !resWheels.ok || !resKeys.ok) throw new Error("íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");
            DB.chars = await resChars.json();
            DB.wheels = await resWheels.json();
            DB.keys = await resKeys.json();
            DB.chars.forEach(c => c.id = String(c.id));
        } catch (error) { console.error(error); alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); }
    }

    function assignTagsToWheels() {
        DB.wheels.forEach(wheel => {
            wheel.tags = [];
            const text = (wheel.description + " " + wheel.main_stat).replace(/\s+/g, '');
            ALL_SEARCH_TAGS.forEach(keyword => {
                const cleanKeyword = keyword.replace(/\s+/g, '');
                if (text.includes(cleanKeyword)) wheel.tags.push(keyword);
            });
        });
    }

    function loadFromLocalStorage() {
        const saved = localStorage.getItem('morimens_v2');
        if(saved) {
            try {
                const loadedTeams = JSON.parse(saved);
                teams = loadedTeams.map((t, i) => ({ ...teams[i], ...t }));
            } catch(e) {}
        }
    }

    function saveAllData(silent = false) {
        localStorage.setItem('morimens_v2', JSON.stringify(teams));
        // silentê°€ trueë©´ ì•Œë¦¼ ì—†ì´ ì¡°ìš©íˆ ì €ì¥ (ì´ˆê¸°í™” ë¡œì§ ë“±ì—ì„œ ì‚¬ìš©)
        if (!silent) {
            openSystemAlert("ì €ì¥ ì™„ë£Œ", "ëª¨ë“  íŒ€ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    function renderAll() { renderSidebar(); renderMain(); }

    function renderSidebar() {
        const c = document.getElementById('sidebar-tabs'); c.innerHTML = '';
        teams.forEach((t, i) => {
            const d = document.createElement('div');
            d.className = `team-tab ${i === currentTeamIdx ? 'active' : ''} ${t.chars.some(x=>x)?'filled':''}`;
            d.textContent = ROMAN_NUMS[i];
            d.onclick = () => { currentTeamIdx = i; renderAll(); };
            c.appendChild(d);
        });
    }

    function renderMain() {
        const team = teams[currentTeamIdx];
        document.getElementById('team-title-text').textContent = team.name;
        renderTeamDomainImage(team);
        const sBox = document.getElementById('team-slots'); sBox.innerHTML = '';
        const domSet = getActiveDomains(team);
        const isConflictGlobal = (domSet.size > 2);

        for(let i=0; i<4; i++) {
            const cid = team.chars[i];
            const div = document.createElement('div');
            div.className = 'char-card';
            if(cid) {
                const info = DB.chars.find(x => String(x.id) === cid);
                const w1 = team.wheels[i][0]; const w2 = team.wheels[i][1];
                const w1Info = DB.wheels.find(x => x.english_name === w1);
                const w2Info = DB.wheels.find(x => x.english_name === w2);
                let conflictHTML = isConflictGlobal ? `<div class="card-conflict-overlay"><div class="conflict-bar">ì˜ì—­ ì¶©ëŒ</div></div>` : '';
                const charImg = info ? `images/${info.id}_tide.webp` : 'images/smile_Ramona.webp';
                const thumbImg = info ? info.image_thumb : '';
                let topInfoHTML = info ? `<div class="char-top-info"><img src="images/character_${info.relems}.png" class="char-top-icon"><span class="char-top-name">${info.name}</span></div>` : '';
                div.innerHTML = `<img src="${charImg}" class="char-tide-img" onerror="this.src='${thumbImg}'">${conflictHTML}${topInfoHTML}<div class="card-bottom-overlay"><div class="covenant-wrapper"><div class="slot-covenant"></div></div><div class="wheels-wrapper"><div class="slot-wheel" onclick="openWheelModal(${i},0,event)">${w1Info ? `<img src="${w1Info.image_path}">` : '+'}</div><div class="slot-wheel" onclick="openWheelModal(${i},1,event)">${w2Info ? `<img src="${w2Info.image_path}">` : '+'}</div></div></div>`;
                div.onclick = (e) => { if(e.target.closest('.slot-wheel') || e.target.closest('.slot-covenant')) return; openQuickSetup(); };
            } else {
                div.className += ' empty'; div.innerHTML = `<div class="empty-cross"></div><div class="empty-text">ë°°ì¹˜í•  ê°ì„±ì²´ ì„ íƒ</div>`;
                div.onclick = openQuickSetup;
            }
            sBox.appendChild(div);
        }
        const kid = team.key; const kInfo = DB.keys.find(x => x.english_name === kid);
        const kIcon = document.getElementById('key-icon'); const kName = document.getElementById('key-name');
        if(kInfo) { kIcon.innerHTML = `<img src="${kInfo.image_path}">`; kName.textContent = kInfo.korean_name; kName.style.color = '#fff'; }
        else { kIcon.innerHTML = '+'; kName.textContent = 'ì„ íƒ ì•ˆ í•¨'; kName.style.color = '#777'; }
    }

    function editTeamName() {
        const newName = prompt("íŒ€ ì´ë¦„ ì…ë ¥:", teams[currentTeamIdx].name);
        if (newName && newName.trim()) { teams[currentTeamIdx].name = newName.trim(); renderMain(); }
    }

    function getActiveDomains(team) {
        const domSet = new Set();
        team.chars.forEach(cid => { if(!cid) return; const ch = DB.chars.find(x => String(x.id) === cid); if(ch) domSet.add(ch.relems); });
        return domSet;
    }

    function renderTeamDomainImage(team) {
        const container = document.getElementById('team-domain-container'); container.innerHTML = '';
        const domSet = getActiveDomains(team); const domArr = Array.from(domSet);
        if (domArr.length === 0) {
            const emptyDiv = document.createElement('div'); emptyDiv.className = 'team-domain-circle'; emptyDiv.style.opacity = '0.3'; emptyDiv.innerText = '-'; emptyDiv.style.color = '#555'; container.appendChild(emptyDiv); return;
        }
        const circleDiv = document.createElement('div'); circleDiv.className = 'team-domain-circle';
        if (domArr.length > 2) { container.innerHTML = `<span style="color:#e74c3c; font-weight:bold; font-size:0.8em; text-align:center;">âš <br>ì¶©ëŒ</span>`; return; }
        const sortOrder = ['chaos', 'aequor', 'caro', 'ultra']; domArr.sort((a, b) => sortOrder.indexOf(a) - sortOrder.indexOf(b));
        let fileName = domArr.length === 1 ? `pure_${domArr[0]}.png` : `${domArr[0]}_${domArr[1]}.png`;
        const img = document.createElement('img'); img.src = `images/${fileName}`; img.className = 'team-domain-img';
        img.onerror = () => { img.style.display='none'; circleDiv.textContent='?'; };
        circleDiv.appendChild(img); container.appendChild(circleDiv);
        const textSpan = document.createElement('span'); textSpan.className = 'domain-active-text'; textSpan.innerText = 'í™œì„±í™”ë¨'; container.appendChild(textSpan);
    }

    function closeModal(id) { document.getElementById(id).classList.remove('show'); }

    // [ìˆ˜ì •ë¨] ìºë¦­í„° í€µì…‹ì—… ì˜¤í”ˆ ì‹œ í•„í„° ì´ˆê¸°í™”
    function openQuickSetup() {
        tempChars = teams[currentTeamIdx].chars.filter(x => x);
        activeCharFilters.domain.clear();
        activeCharFilters.class.clear();
        updateCharFilterUI(); // UI ì´ˆê¸°í™”
        renderCharGrid();
        document.getElementById('modal-char').classList.add('show');
    }

    // [ì‹ ê·œ] í•„í„° í† ê¸€ ê¸°ëŠ¥
    function toggleCharFilter(type, value) {
        if (activeCharFilters[type].has(value)) {
            activeCharFilters[type].delete(value);
        } else {
            activeCharFilters[type].add(value);
        }
        updateCharFilterUI();
        renderCharGrid();
    }

    // [ì‹ ê·œ] í•„í„° UI ì—…ë°ì´íŠ¸ (í™œì„±í™” í´ë˜ìŠ¤ í† ê¸€)
    function updateCharFilterUI() {
        document.querySelectorAll('.filter-chip').forEach(el => {
            const onclickText = el.getAttribute('onclick');
            if (onclickText) {
                // onclick="toggleCharFilter('domain', 'chaos')" íŒŒì‹±
                const match = onclickText.match(/'(\w+)',\s*'(\w+)'/);
                if (match) {
                    const type = match[1];
                    const value = match[2];
                    if (activeCharFilters[type].has(value)) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                }
            }
        });
    }

    // [ìˆ˜ì •ë¨] ê·¸ë¦¬ë“œ ë Œë”ë§ (í•„í„° ì ìš©)
    function renderCharGrid() {
        const box = document.getElementById('grid-char'); box.innerHTML = '';
        const curSet = new Set();
        tempChars.forEach(id => { const c = DB.chars.find(x => String(x.id) === id); if(c) curSet.add(c.relems); });
        const usedMap = new Set();
        teams.forEach((t, i) => { if(i!==currentTeamIdx) t.chars.forEach(id => { if(id) usedMap.add(id); }); });

        // í•„í„° ë¡œì§ ì ìš©
        const filteredChars = DB.chars.filter(c => {
            // ì˜ì—­ í•„í„° (OR ì¡°ê±´: ì„ íƒëœ ê²ƒ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ OK, ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´)
            const domainPass = (activeCharFilters.domain.size === 0) || activeCharFilters.domain.has(c.relems);
            // ì§ì—… í•„í„°
            const classPass = (activeCharFilters.class.size === 0) || activeCharFilters.class.has(c.class);

            return domainPass && classPass;
        });

        filteredChars.forEach(c => {
            const id = String(c.id);
            const isSel = tempChars.includes(id);
            const isUsed = usedMap.has(id);
            const isConflict = (!isSel && curSet.size >= 2 && !curSet.has(c.relems));

            const el = document.createElement('div');
            el.className = `grid-item ${isSel?'selected':''} ${isUsed?'disabled':''} ${isConflict?'conflict':''}`;
            el.innerHTML = `<img src="${c.image_thumb}">`;
            el.onclick = () => {
                if(isUsed) return;
                if(isSel) tempChars = tempChars.filter(x => x !== id);
                else {
                    if(isConflict) return;
                    if(tempChars.length >= 4) return alert("ìµœëŒ€ 4ëª…");
                    tempChars.push(id);
                }
                renderCharGrid();
            };
            box.appendChild(el);
        });
        document.getElementById('char-count').textContent = `${tempChars.length} / 4 ì„ íƒë¨`;
    }

    function confirmQuickSetup() {
        const newArr = [null,null,null,null];
        tempChars.forEach((id, i) => { if(i<4) newArr[i] = id; });
        for(let i=0; i<4; i++) { if(teams[currentTeamIdx].chars[i] !== newArr[i]) teams[currentTeamIdx].wheels[i] = [null,null]; }
        teams[currentTeamIdx].chars = newArr;
        closeModal('modal-char');
        renderAll();
    }

    function openWheelModal(charIdx, slotIdx, e) {
        if(!teams[currentTeamIdx].chars[charIdx]) return alert("ë¨¼ì € ìºë¦­í„°ë¥¼ ë°°ì¹˜í•´ì£¼ì„¸ìš”.");
        editingCharIdx = charIdx; selectedWheelSlotIdx = slotIdx; if(e) e.stopPropagation();
        activeWheelTags.clear(); document.getElementById('wheel-search-input').value = '';
        renderActiveTags(); setupSearchEvents(); renderWheelModalUI(); document.getElementById('modal-wheel').classList.add('show');
    }

    function selectWheelSlot(slotIdx) { selectedWheelSlotIdx = slotIdx; renderWheelModalUI(); }

    function renderWheelModalUI() {
        const wheels = teams[currentTeamIdx].wheels[editingCharIdx];
        for(let i=0; i<2; i++) {
            const slotEl = document.getElementById(`equip-slot-${i}`); const wId = wheels[i];
            if(i === selectedWheelSlotIdx) slotEl.classList.add('active'); else slotEl.classList.remove('active');
            if(wId) {
                const wInfo = DB.wheels.find(w => w.english_name === wId); slotEl.innerHTML = `<img src="${wInfo.image_path}">`;
                if(i === selectedWheelSlotIdx) document.getElementById('equip-slot-desc').textContent = wInfo.korean_name;
            } else {
                slotEl.innerHTML = `<div class="slot-placeholder">+</div>`;
                if(i === selectedWheelSlotIdx) document.getElementById('equip-slot-desc').textContent = "ì¥ì°©í•  ì•„ì´í…œì„ ì„ íƒí•˜ì„¸ìš”";
            }
        }
        renderWheelList();
    }

    function renderWheelList() {
        const box = document.getElementById('grid-wheel'); box.innerHTML = '';
        const used = new Set(); teams.forEach(t => t.wheels.forEach(row => row.forEach(w => { if(w) used.add(w); })));
        const currentEquippedId = teams[currentTeamIdx].wheels[editingCharIdx][selectedWheelSlotIdx];
        const searchText = document.getElementById('wheel-search-input').value.trim().toLowerCase();
        const filteredList = DB.wheels.filter(w => {
            if (activeWheelTags.size > 0) {
                const wTags = w.tags || [];
                const hasAllTags = Array.from(activeWheelTags).every(tag => wTags.includes(tag));
                if(!hasAllTags) return false;
            }
            if (searchText.length > 0) return w.korean_name.includes(searchText) || w.description.includes(searchText);
            return true;
        });
        filteredList.forEach(w => {
            const id = w.english_name; const isSel = (id === currentEquippedId); const isUsed = used.has(id) && !isSel;
            const el = document.createElement('div'); el.className = `grid-item grid-item-wheel ${isSel?'selected':''} ${isUsed?'disabled':''}`;
            el.innerHTML = `<img src="${w.image_path}">`;
            el.onmouseenter = (e) => showTooltip(w, e); el.onmousemove = (e) => moveTooltip(e); el.onmouseleave = () => hideTooltip();
            el.onclick = () => { if(isUsed) return; teams[currentTeamIdx].wheels[editingCharIdx][selectedWheelSlotIdx] = id; renderWheelModalUI(); renderAll(); };
            box.appendChild(el);
        });
        if(filteredList.length === 0) box.innerHTML = `<div class="no-result-message">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
    }

    function setupSearchEvents() {
        const input = document.getElementById('wheel-search-input'); const suggestBox = document.getElementById('search-suggestions');
        input.oninput = (e) => {
            const val = e.target.value.trim();
            if(val.length < 1) { suggestBox.style.display = 'none'; renderWheelList(); return; }
            const matches = ALL_SEARCH_TAGS.filter(tag => tag.includes(val) && !activeWheelTags.has(tag));
            if(matches.length > 0) {
                suggestBox.innerHTML = '';
                matches.forEach(tag => {
                    const div = document.createElement('div'); div.className = 'suggestion-item';
                    const regex = new RegExp(`(${val})`, 'gi'); div.innerHTML = tag.replace(regex, `<span class="suggestion-match">$1</span>`);
                    div.onclick = () => { addActiveTag(tag); input.value = ''; suggestBox.style.display = 'none'; };
                    suggestBox.appendChild(div);
                }); suggestBox.style.display = 'block';
            } else { suggestBox.style.display = 'none'; }
            renderWheelList();
        };
        input.onkeydown = (e) => { if(e.key === 'Enter') { suggestBox.style.display = 'none'; renderWheelList(); } };
    }

    function addActiveTag(tag) { activeWheelTags.add(tag); renderActiveTags(); renderWheelList(); }
    function removeActiveTag(tag) { activeWheelTags.delete(tag); renderActiveTags(); renderWheelList(); }
    function renderActiveTags() {
        const container = document.getElementById('active-tags-area'); container.innerHTML = '';
        activeWheelTags.forEach(tag => {
            const chip = document.createElement('div'); chip.className = 'active-tag-chip'; chip.textContent = tag;
            chip.onclick = () => removeActiveTag(tag); container.appendChild(chip);
        });
    }
    function unequipSelectedWheel() { teams[currentTeamIdx].wheels[editingCharIdx][selectedWheelSlotIdx] = null; renderWheelModalUI(); renderAll(); }

    function openKeyModal() {
        activeKeyTags.clear(); document.getElementById('key-search-input').value = '';
        renderActiveKeyTags(); setupKeySearchEvents(); renderKeyGrid(); document.getElementById('modal-key').classList.add('show');
    }

    function renderKeyGrid() {
        const box = document.getElementById('grid-key'); box.innerHTML = '';
        const used = new Set(); teams.forEach((t, i) => { if(i !== currentTeamIdx && t.key) used.add(t.key); });
        const curK = teams[currentTeamIdx].key;
        const searchText = document.getElementById('key-search-input').value.trim().toLowerCase();
        const filteredKeys = DB.keys.filter(k => {
            if (activeKeyTags.size > 0) {
                const kTags = k.tags || []; const hasAllTags = Array.from(activeKeyTags).every(tag => kTags.includes(tag)); if(!hasAllTags) return false;
            }
            if (searchText.length > 0) return k.korean_name.includes(searchText) || k.description.includes(searchText);
            return true;
        });
        if (filteredKeys.length === 0) { box.innerHTML = `<div class="no-result-message">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`; return; }
        filteredKeys.forEach(k => {
            const id = k.english_name; const isSel = (id === curK); const isUsed = used.has(id);
            const el = document.createElement('div'); el.className = `grid-item ${isSel?'selected':''} ${isUsed?'disabled':''}`; el.style.borderRadius = "50%";
            el.innerHTML = `<img src="${k.image_path}" style="border-radius:50%;">`;
            el.onmouseenter = (e) => showTooltip(k, e); el.onmousemove = (e) => moveTooltip(e); el.onmouseleave = () => hideTooltip();
            el.onclick = () => { if(isUsed) return; teams[currentTeamIdx].key = id; closeModal('modal-key'); renderAll(); };
            box.appendChild(el);
        });
    }
    function unequipKey() { teams[currentTeamIdx].key = null; closeModal('modal-key'); renderAll(); }

    const tooltipEl = document.getElementById('global-tooltip');
    const ttTitle = document.getElementById('tt-title'); const ttDesc = document.getElementById('tt-desc'); const ttTags = document.getElementById('tt-tags');
    function showTooltip(item, e) {
        ttTitle.textContent = item.korean_name; ttDesc.textContent = item.description; ttTags.innerHTML = '';
        if(item.tags && item.tags.length > 0) {
            item.tags.forEach(tag => { const span = document.createElement('span'); span.className = 'tooltip-tag'; span.textContent = tag; ttTags.appendChild(span); });
        }
        tooltipEl.style.display = 'block'; moveTooltip(e);
    }
    function moveTooltip(e) {
        const offset = 15; let left = e.clientX + offset; let top = e.clientY + offset;
        if (left + 320 > window.innerWidth) left = e.clientX - 320;
        if (top + 150 > window.innerHeight) top = e.clientY - 150;
        tooltipEl.style.left = left + 'px'; tooltipEl.style.top = top + 'px';
    }
    function hideTooltip() { tooltipEl.style.display = 'none'; }

    function setupKeySearchEvents() {
        const input = document.getElementById('key-search-input'); const suggestBox = document.getElementById('key-search-suggestions');
        input.oninput = (e) => {
            const val = e.target.value.trim();
            if(val.length < 1) { suggestBox.style.display = 'none'; renderKeyGrid(); return; }
            const matches = ALL_KEY_TAGS.filter(tag => tag.includes(val) && !activeKeyTags.has(tag));
            if(matches.length > 0) {
                suggestBox.innerHTML = '';
                matches.forEach(tag => {
                    const div = document.createElement('div'); div.className = 'suggestion-item';
                    const regex = new RegExp(`(${val})`, 'gi'); div.innerHTML = tag.replace(regex, `<span class="suggestion-match">$1</span>`);
                    div.onclick = () => { addActiveKeyTag(tag); input.value = ''; suggestBox.style.display = 'none'; };
                    suggestBox.appendChild(div);
                }); suggestBox.style.display = 'block';
            } else { suggestBox.style.display = 'none'; }
            renderKeyGrid();
        };
        input.onkeydown = (e) => { if(e.key === 'Enter') { suggestBox.style.display = 'none'; renderKeyGrid(); } };
    }
    function addActiveKeyTag(tag) { activeKeyTags.add(tag); renderActiveKeyTags(); renderKeyGrid(); }
    function removeActiveKeyTag(tag) { activeKeyTags.delete(tag); renderActiveKeyTags(); renderKeyGrid(); }
    function renderActiveKeyTags() {
        const container = document.getElementById('active-key-tags-area'); container.innerHTML = '';
        activeKeyTags.forEach(tag => {
            const chip = document.createElement('div'); chip.className = 'active-tag-chip'; chip.textContent = tag;
            chip.onclick = () => removeActiveKeyTag(tag); container.appendChild(chip);
        });
    }

    // [ì‹ ê·œ] ì‹œìŠ¤í…œ ì•Œë¦¼ì°½ (alert ëŒ€ì²´)
    function openSystemAlert(title, msg) {
        document.getElementById('sys-modal-title').innerText = title;
        document.getElementById('sys-modal-msg').innerText = msg;
        document.getElementById('sys-btn-no').style.display = 'none'; // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¹€

        const yesBtn = document.getElementById('sys-btn-yes');
        yesBtn.innerText = "í™•ì¸";
        yesBtn.onclick = () => closeModal('modal-system');

        document.getElementById('modal-system').classList.add('show');
    }

    // [ì‹ ê·œ] ì‹œìŠ¤í…œ í™•ì¸ì°½ (confirm ëŒ€ì²´)
    function openSystemConfirm(title, msg, yesCallback) {
        document.getElementById('sys-modal-title').innerText = title;
        document.getElementById('sys-modal-msg').innerText = msg;

        const noBtn = document.getElementById('sys-btn-no');
        noBtn.style.display = 'inline-block'; // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ê¸°
        noBtn.onclick = () => closeModal('modal-system');

        const yesBtn = document.getElementById('sys-btn-yes');
        yesBtn.innerText = "ë„¤";
        yesBtn.onclick = () => {
            yesCallback();
            closeModal('modal-system');
        };

        document.getElementById('modal-system').classList.add('show');
    }

    /* --- [í†µí•© ìˆ˜ì •ë³¸] ì‹ ê³  ëª¨ë‹¬ ë¡œì§ (links.htmlê³¼ 100% ë™ì¼ + ë°°ê²½ í´ë¦­ ë‹«ê¸° ë³´ì¥) --- */

    // 1. ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
    function openReportModal() {
        const modal = document.getElementById('report-modal');
        const sourceUrlInput = document.getElementById('report-source-url');
        const modalStatus = document.getElementById('modal-form-status');

        if (modalStatus) {
            modalStatus.style.display = 'none';
            modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';
            modalStatus.style.color = '#ffc107';
        }
        if (sourceUrlInput) { sourceUrlInput.value = window.location.href; }

        modal.classList.add('show');
    }

    // 2. ë””ìŠ¤ì½”ë“œ ì „ì†¡ í•¨ìˆ˜
    async function sendToDiscord(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const modalStatus = document.getElementById('modal-form-status');
        const modal = document.getElementById('report-modal');

        if (modalStatus) {
            modalStatus.style.display = 'block';
            modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';
            modalStatus.style.color = '#ffc107';
        }

        const reporterEmail = formData.get('_replyto') || 'ìµëª…(Anonymous)';
        const message = formData.get('message');
        const sourceUrl = formData.get('report_source_url') || window.location.href;

        const payload = {
            username: "Morimens Wiki Bot",
            embeds: [{
                title: "ğŸ“© ìƒˆë¡œìš´ ì œë³´ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!",
                description: "ìœ„í‚¤ì—ì„œ ìœ ì € í”¼ë“œë°±/ë²„ê·¸ ì œë³´ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.",
                color: 0xFF9F43,
                fields: [
                    { name: "ğŸ‘¤ ì œë³´ì", value: `\`${reporterEmail}\``, inline: true },
                    { name: "ğŸ“ ë°œìƒ í˜ì´ì§€", value: `[ë°”ë¡œê°€ê¸°(Click)](${sourceUrl})`, inline: true },
                    { name: "ğŸ“ ìƒì„¸ ë‚´ìš©", value: `>>> ${message}`, inline: false }
                ],
                footer: { text: "Morimens Wiki Report System" },
                timestamp: new Date().toISOString()
            }]
        };

        try {
            const webhookUrl = (typeof CONFIG !== 'undefined') ? CONFIG.DISCORD_WEBHOOK_URL : '';
            if(!webhookUrl) throw new Error("Config Error");

            await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (modalStatus) {
                modalStatus.textContent = "âœ… ì „ì†¡ ì™„ë£Œ! ê°ì‚¬í•©ë‹ˆë‹¤.";
                modalStatus.style.color = "#2ecc71";
            }
            form.reset();
            setTimeout(() => {
                modal.classList.remove('show');
                if (modalStatus) {
                    modalStatus.style.display = 'none';
                    modalStatus.textContent = 'ì „ì†¡ ì¤‘...';
                }
            }, 1500);
        } catch (error) {
            console.error(error);
            if (modalStatus) {
                modalStatus.textContent = 'âŒ ì„¤ì • ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.';
                modalStatus.style.color = "#e74c3c";
            }
        }
    }

    // 3. [í•µì‹¬ ìˆ˜ì •] ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸° (ë¡œë”© ì™„ë£Œ í›„ ì‹¤í–‰ ë³´ì¥)
    document.addEventListener('DOMContentLoaded', () => {
        const reportModal = document.getElementById('report-modal');
        if (reportModal) {
            reportModal.addEventListener('click', (e) => {
                // ê²€ì€ ë°°ê²½(Overlay)ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ë‹«ê¸°
                if (e.target === reportModal) {
                    reportModal.classList.remove('show');
                }
            });
        }
    });
</script>

<div id="report-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="form-title">ğŸš¨ ë²„ê·¸ ì œë³´ or í”¼ë“œë°±</h2>
        <p style="color:#aaa; font-size:0.9em;">ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. ê°œë°œìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p>

        <form id="bug-report-form" action="javascript:void(0);" onsubmit="sendToDiscord(event)" method="POST">

            <label for="reporter-email" class="form-field-label">íŒ¨ì¹˜ë…¸íŠ¸ì— ì˜¬ë¼ê°ˆ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
            <input type="text" id="reporter-email" name="_replyto" class="form-input"
                   placeholder="íŒ¨ì¹˜ë…¸íŠ¸ì— ì–¸ê¸‰ì„ ì›í•˜ì‹œë©´ ì ì–´ì£¼ì„¸ìš”.">

            <label for="report-message" class="form-field-label">
                ì œë³´í•  ë‚´ìš© (ë²„ê·¸ or í”¼ë“œë°±) (í•„ìˆ˜)
                <span style="display:block; margin-top:5px; font-size:0.9em; color:#ff9f43; font-weight:normal;">
                        â€» íŠ¹ì • ê²Œì‹œê¸€/ì •ë³´ ê´€ë ¨ ì œë³´ë¼ë©´, <u>í•´ë‹¹ ê¸€ì˜ ë§í¬</u>ë¥¼ ë³¸ë¬¸ì— ê¼­ ì ì–´ì£¼ì„¸ìš”!
                    </span>
            </label>
            <textarea id="report-message" name="message" class="form-textarea" required
                      placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 'XX ìºë¦­í„° ê³µëµ ë§í¬ê°€ ì•ˆ ì—´ë ¤ìš”', 'ì´ ë§í¬(URL) ì ‘ì†ì´ ì•ˆ ë¼ìš”')"></textarea>

            <input type="hidden" name="report_source_url" id="report-source-url">
            <button type="submit" class="form-submit-btn">ì œë³´ ë³´ë‚´ê¸°</button>
            <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">ì „ì†¡ ì¤‘...</p>
        </form>
    </div>
</div>

<button class="floating-report-btn" onclick="openReportModal()" title="ë²„ê·¸ ì‹ ê³ ">
    ğŸš¨
</button>
</body>
</html>