<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ - ë§ê°ì „ì•¼</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .link-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .category-title { color: #ffc107; border-bottom: 2px solid #555; padding-bottom: 15px; margin-bottom: 30px; font-size: 1.8em; text-align: left; display: flex; align-items: center; gap: 10px; }
        .title-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid #555; }
        .notion-bookmark { display: flex; background-color: #2a2a2a; border: 1px solid #444; border-radius: 6px; text-decoration: none; color: #eee; margin-bottom: 16px; transition: all 0.2s; height: 130px; overflow: hidden; }
        .notion-bookmark:hover { background-color: #353535; border-color: #888; transform: translateY(-2px); }
        .bookmark-content { flex: 1; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; min-width: 0; }
        .bookmark-title { font-size: 1.1em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; margin-bottom: 5px; }
        .bookmark-desc { font-size: 0.9em; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        .bookmark-url { font-size: 0.75em; color: #666; margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        .bookmark-image { width: 200px; background-color: #111; flex-shrink: 0; }
        .bookmark-image img { width: 100%; height: 100%; object-fit: cover; }
        .no-data { text-align: center; padding: 50px; color: #777; border: 2px dashed #444; border-radius: 10px; }
        .report-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #444; text-align: center; color: #777; font-size: 0.9em; }
        .report-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #333; color: #ccc; text-decoration: none; border-radius: 20px; border: 1px solid #555; transition: all 0.2s; }
        .report-btn:hover { background-color: #444; color: #fff; border-color: #ffc107; }
        .text-link-box {
            display: block;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 12px; /* ë¼ìš´ë“œ ë°•ìŠ¤ í¬ê¸° í‚¤ì›€ */
            padding: 20px;
            margin-bottom: 12px;

            /* ğŸ”¥ í•µì‹¬: ê¸€ ì „ì²´ ì¤‘ì•™ ì •ë ¬ */
            text-align: center;
            color: #fff; /* ì „ì²´ ê¸€ì”¨ ìƒ‰ í°ìƒ‰ìœ¼ë¡œ ì„¤ì • */

            transition: background-color 0.2s;
            font-size: 1.1em;
            line-height: 1.6; /* ì½”ë“œ ëª©ë¡ ê°€ë…ì„± ë†’ì´ê¸° */
        }

        .code-warning-text {
            font-size: 0.85em;
            color: #999; /* ë°ì€ íšŒìƒ‰ */
            text-align: center;
            margin-bottom: 15px;
            padding: 8px 15px;
            background-color: #333; /* ì–´ë‘ìš´ ë°°ê²½ */
            border-radius: 8px;
        }
    </style>
</head>
<body>
<div class="container">
    <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

    <div class="link-container">
        <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <div id="links-list"></div>

        <div class="report-section">
            <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
            <a href="report.html" class="report-btn">
                ğŸš¨ ê¹¨ì§„ ë§í¬ ì œë³´í•˜ê¸°
            </a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const charId = urlParams.get('id');
        const titleEl = document.getElementById('page-title');
        const listEl = document.getElementById('links-list');

        try {
            // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„
            const ts = new Date().getTime();
            const [manifestRes, linksRes] = await Promise.all([
                fetch(`data/character_manifest.json?t=${ts}`),
                fetch(`data/resource_links.json?t=${ts}`)
            ]);

            if(!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

            const manifest = await manifestRes.json();
            const linksDB = await linksRes.json();

            let targetItems = [];
            let pageTitleHTML = "";

            // íƒ€ì´í‹€ ë° íƒ€ê²Ÿ ì•„ì´í…œ ì„¤ì •
            if (category === 'character' && charId) {
                const charData = manifest.find(c => String(c.id) === String(charId));
                if (charData) {
                    pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                    targetItems = linksDB.characters[charId] || [];
                } else { pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°"; }
            } else if (category && linksDB.categories[category]) {
                pageTitleHTML = linksDB.categories[category].title;
                targetItems = linksDB.categories[category].links || [];
            } else { pageTitleHTML = "ì˜ëª»ëœ ì ‘ê·¼"; }

            titleEl.innerHTML = pageTitleHTML;
            listEl.innerHTML = '';

            if (targetItems.length === 0) {
                listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                return;
            }

            // ğŸš©ğŸš©ğŸš© ë©”ì¸ ë Œë”ë§ ë£¨í”„: ì¹´í…Œê³ ë¦¬ë³„ ë¶„ê¸° ì²˜ë¦¬ ğŸš©ğŸš©ğŸš©
            if (category === 'code') {
                // êµí™˜ì½”ë“œ: í…ìŠ¤íŠ¸ ì „ìš© ë Œë”ëŸ¬ í˜¸ì¶œ (ì´ë¯¸ì§€ ì—†ìŒ)
                renderCodeLinks(targetItems, listEl);
            } else {
                // ì¼ë°˜: ì´ë¯¸ì§€ ì¹´ë“œ ë Œë”ë§
                targetItems.forEach(item => {
                    if (typeof item === 'string') {
                        // ë¬¸ìì—´(URL)ì´ë©´ API í˜¸ì¶œ (ëŠë¦¼ - ê°œë°œ ì‹œì—ë§Œ ì‚¬ìš© ê¶Œì¥)
                        createLinkCardFromAPI(item, listEl);
                    } else {
                        // ê°ì²´(Object)ë©´ ì¦‰ì‹œ ìƒì„± (ë¹ ë¦„)
                        createLinkCardInstant(item, listEl);
                    }
                });
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
            listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
        }

        const reportBtn = document.querySelector('.report-btn');
        if (reportBtn) {
            const currentPageUrl = window.location.href;
            const initialHref = reportBtn.getAttribute('href');

            // í˜„ì¬ í˜ì´ì§€ ì£¼ì†Œë¥¼ URL ì¸ì½”ë”©í•˜ì—¬ ì´ë©”ì¼ ë³¸ë¬¸(body)ì— ì¶”ê°€
            // %0AëŠ” ì¤„ë°”ê¿ˆ ë¬¸ìì…ë‹ˆë‹¤.
            reportBtn.href = `${initialHref}%0A%0A--- ì œë³´ ìœ„ì¹˜ ---%0A${encodeURIComponent(currentPageUrl)}`;
        }
    });

    // -----------------------------------------------------
    // ğŸš© [í•µì‹¬] ì´ë¯¸ì§€ í”„ë¡ì‹œ ë³€í™˜ê¸°
    // -----------------------------------------------------
    function getProxyImage(url) {
        if (!url) return 'images/morimens Icon.webp';
        url = url.trim();

        // 1. í”„ë¡œí† ì½œ(//) ë³´ì •
        if (url.startsWith('//')) {
            url = 'https:' + url;
        }

        // 2. ì™¸ë¶€ ì´ë¯¸ì§€ëŠ” í”„ë¡ì‹œ ì„œë²„ ì‚¬ìš© (Hotlink Protection ìš°íšŒ)
        if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
            return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
        }

        return url;
    }

    // -----------------------------------------------------
    // ğŸš© [ê¸°ëŠ¥] í…ìŠ¤íŠ¸ ì „ìš© ì¹´ë“œ ë Œë”ëŸ¬ (êµí™˜ ì½”ë“œìš©)
    // -----------------------------------------------------
    async function renderCodeLinks(urls, container) {

        // 1. ê²½ê³  ë¬¸êµ¬ ì‚½ì…
        const warningHtml = '<div class="code-warning-text">ë§Œë£Œëœ êµí™˜ ì½”ë“œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
        container.insertAdjacentHTML('beforebegin', warningHtml);

        // 2. ëª¨ë“  ì½”ë“œë¥¼ ë‹´ì„ ë‹¨ í•˜ë‚˜ì˜ ë°•ìŠ¤ë¥¼ ìƒì„±
        const codeBox = document.createElement('div');
        codeBox.className = 'text-link-box';

        let codeContentHTML = '';

        // 3. ë°°ì—´ì„ ìˆœíšŒí•˜ë©° ì½”ë“œë¥¼ HTML í˜•ì‹ìœ¼ë¡œ ì •ë¦¬
        urls.forEach(item => {
            let codeLine = '';

            if (typeof item === 'object') {
                // êµ¬ì¡°í™”ëœ ë°ì´í„°ì¼ ê²½ìš° (titleê³¼ descë¥¼ í•œ ì¤„ë¡œ í•©ì¹¨)
                codeLine = `<b>${item.title}</b>: ${item.desc || item.url || ''}`;
            } else {
                // ë‹¨ìˆœ ë¬¸ìì—´(raw code)ì¼ ê²½ìš°
                codeLine = item;
            }

            // ê° ì½”ë“œë¥¼ ë³„ë„ì˜ ì¤„ë¡œ ë§Œë“¤ì–´ codeContentì— ì¶”ê°€
            codeContentHTML += `<div style="margin: 5px 0;">${codeLine}</div>`;
        });

        // 4. ë°•ìŠ¤ì— ëª¨ë“  ì½”ë“œë¥¼ ì£¼ì…
        codeBox.innerHTML = codeContentHTML;

        // 5. ìµœì¢… ë°•ìŠ¤ë¥¼ ì»¨í…Œì´ë„ˆì— ì‚½ì…
        container.appendChild(codeBox);
    }

    // -----------------------------------------------------
    // ğŸš© [ê¸°ëŠ¥] ì¦‰ì‹œ ë Œë”ë§ í•¨ìˆ˜ (ë² ì´í‚¹ëœ ë°ì´í„°ìš©)
    // -----------------------------------------------------
    function createLinkCardInstant(data, container) {
        try {
            const domain = new URL(data.url).hostname;
            const safeImage = getProxyImage(data.image); // í”„ë¡ì‹œ ì ìš©

            const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/morimens Icon.webp';">
                    </div>
                </a>`;
            container.insertAdjacentHTML('beforeend', html);
        } catch (e) {
            console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e);
        }
    }

    // -----------------------------------------------------
    // ğŸš© [ê¸°ëŠ¥] API ë¡œë”© í•¨ìˆ˜ (ëŠë¦¼ - String URL ìš©)
    // -----------------------------------------------------
    async function createLinkCardFromAPI(url, container) {
        // ì´ í•¨ìˆ˜ëŠ” ëŠë ¤ì„œ ì‚¬ìš©ì„ ê¶Œì¥í•˜ì§€ ì•Šì§€ë§Œ, êµ¬ì¡°ìƒ í¬í•¨ë©ë‹ˆë‹¤.
        const cardWrap = document.createElement('div');
        cardWrap.className = 'skeleton skeleton-card';
        cardWrap.innerHTML = `<div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div>`;
        container.appendChild(cardWrap);

        try {
            const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
            const res = await fetch(apiUrl);
            const json = await await res.json();

            if (json.status === 'success') {
                const data = json.data;
                const safeImage = getProxyImage(data.image?.url);

                cardWrap.className = 'notion-bookmark';
                cardWrap.innerHTML = '';

                const linkEl = document.createElement('a');
                linkEl.href = url;
                linkEl.target = "_blank";
                linkEl.className = "notion-bookmark";
                linkEl.style.width = "100%";
                linkEl.innerHTML = `
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title || url}</div>
                            <div class="bookmark-desc">${data.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        </div>
                        <div class="bookmark-url">ğŸ”— ${data.publisher || 'Link'}</div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy"
                             onerror="this.onerror=null; this.src='images/morimens Icon.webp';">
                    </div>`;

                container.replaceChild(linkEl, cardWrap);
            } else { throw new Error("API Fail"); }
        } catch (e) {
            cardWrap.className = 'notion-bookmark';
            cardWrap.innerHTML = `<a href="${url}" target="_blank" style="padding:20px; color:#fff; text-decoration:none; width:100%; display:block;">
                <div style="font-weight:bold; margin-bottom:5px;">${url}</div>
                <div style="font-size:0.8em; color:#aaa;">(ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ - ì½˜ì†” í™•ì¸)</div>
            </a>`;
        }
    }
</script>
</body>
</html>