<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="icon" type="image/webp" href="images/smile_Ramona.webp">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://morimenz-kr.github.io/Morimens.Info.kr/">
    <meta property="og:title" content="ë¯¸ì‚¬ê·¸ ëŒ€í•™ í•œêµ­ ìº í¼ìŠ¤">
    <meta property="og:description" content="ìºë¦­í„° ê³µëµ, í™˜ëª½ì‹¬ì , ìœµì¬ê¸ˆêµ¬, ì¿ í° ë“± ë¯¸ì‚¬ê·¸ ëŒ€í•™ì˜ ëª¨ë“  ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://morimenz-kr.github.io/Morimens.Info.kr/images/background.png">

    <!-- CSS íŒŒì¼ ì—°ê²° -->
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages/links.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- Config íŒŒì¼ ë¡œë“œ -->
    <script src="config/config.js"></script>
</head>

<body>

    <div class="container" style="position: relative; z-index: 2;">
        <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

        <div class="link-container">
            <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
            <div id="links-list"></div>

            <div class="report-section">
                <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
                <a href="#" id="open-report-modal" class="report-btn">
                    ğŸš¨ ë²„ê·¸/í”¼ë“œë°± ì œë³´í•˜ê¸°
                </a>
            </div>
        </div>
    </div>

    <div id="report-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="form-title">ğŸš¨ ë²„ê·¸ ì œë³´ or í”¼ë“œë°±</h2>
            <p style="color:#aaa; font-size:0.9em;">ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. ê°œë°œìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p>

            <form id="bug-report-form" action="javascript:void(0);" onsubmit="sendToDiscord(event)" method="POST">

                <label for="reporter-email" class="form-field-label">íŒ¨ì¹˜ë…¸íŠ¸ì— ì˜¬ë¼ê°ˆ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
                <input type="text" id="reporter-email" name="_replyto" class="form-input"
                    placeholder="íŒ¨ì¹˜ë…¸íŠ¸ì— ì–¸ê¸‰ì„ ì›í•˜ì‹œë©´ ì ì–´ì£¼ì„¸ìš”.">

                <label for="report-message" class="form-field-label">ì œë³´í•  ë‚´ìš© (ë²„ê·¸ or í”¼ë“œë°±) (í•„ìˆ˜)</label>
                <textarea id="report-message" name="message" class="form-textarea" required
                    placeholder="ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>

                <input type="hidden" name="report_source_url" id="report-source-url">
                <input type="hidden" name="_subject" value="[Morimens Wiki] ë²„ê·¸/í”¼ë“œë°± ì ‘ìˆ˜">

                <button type="submit" class="form-submit-btn">ì œë³´ ë³´ë‚´ê¸°</button>
                <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">ì „ì†¡
                    ì¤‘...</p>
            </form>

        </div>
    </div>

    <script>
        // ğŸš© ì „ì—­ ë³µì‚¬ í•¨ìˆ˜
        function copyCodeToClipboard(text, element) {
            if (!navigator.clipboard) {
                alert("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                element.classList.add('copied');
                const originalText = element.innerHTML;
                element.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                setTimeout(() => {
                    element.classList.remove('copied');
                    element.innerHTML = originalText;
                }, 800);
            }).catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            const charId = urlParams.get('id');
            const titleEl = document.getElementById('page-title');
            const listEl = document.getElementById('links-list');
            const modal = document.getElementById('report-modal');
            const openModalBtn = document.getElementById('open-report-modal');
            const sourceUrlInput = document.getElementById('report-source-url');
            const reportForm = document.getElementById('bug-report-form');
            const modalStatus = document.getElementById('modal-form-status');

            try {
                const ts = new Date().getTime();
                const [manifestRes, linksRes] = await Promise.all([
                    fetch(`data/character_manifest.json?t=${ts}`),
                    fetch(`data/resource_links.json?t=${ts}`)
                ]);

                if (!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

                const manifest = await manifestRes.json();
                const linksDB = await linksRes.json();
                let targetItems = [];
                let pageTitleHTML = "";

                if (category === 'character' && charId) {
                    const charData = manifest.find(c => String(c.id) === String(charId));
                    if (charData) {
                        pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                        targetItems = linksDB.characters[charId] || [];
                    } else { pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°"; }
                } else if (category && linksDB.categories[category]) {
                    pageTitleHTML = linksDB.categories[category].title;
                    targetItems = linksDB.categories[category].links || [];
                } else { pageTitleHTML = "ì˜ëª»ëœ ì ‘ê·¼"; }

                titleEl.innerHTML = pageTitleHTML;
                listEl.innerHTML = '';

                if (targetItems.length === 0) {
                    listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                }

                // ë Œë”ë§ ë¶„ê¸°
                if (category === 'code') {
                    renderCodeLinks(targetItems, listEl);
                } else {
                    targetItems.forEach(item => {
                        if (typeof item === 'string') {
                            createLinkCardFromAPI(item, listEl);
                        } else {
                            createLinkCardInstant(item, listEl);
                        }
                    });
                }

            } catch (error) {
                console.error(error);
                titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
                listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
            }

            // íŒì—… ë¡œì§
            if (openModalBtn) {
                openModalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    modal.classList.add('show');
                    sourceUrlInput.value = window.location.href;
                });
            }
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('show');
                });
            }
            if (reportForm) {
                reportForm.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    modalStatus.style.display = 'block';
                    modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';

                    const data = new FormData(e.target);
                    const reporterEmail = data.get('_replyto') || 'N/A';
                    const message = data.get('message');
                    const sourceUrl = data.get('report_source_url');
                    const DISCORD_ENDPOINT = e.target.action;

                    const payload = {
                        username: "Morimens Wiki Reporter",
                        embeds: [{
                            title: "ğŸš¨ ì‹ ê·œ ê¹¨ì§„ ë§í¬ ì œë³´ ì ‘ìˆ˜",
                            color: 15777040,
                            fields: [
                                { name: "ì œë³´ì ì´ë©”ì¼", value: reporterEmail, inline: false },
                                { name: "ì œë³´ í˜ì´ì§€", value: `[ë§í¬](${sourceUrl})`, inline: false },
                                { name: "ìƒì„¸ ë‚´ìš©", value: message, inline: false },
                            ],
                            timestamp: new Date().toISOString()
                        }]
                    };

                    try {
                        const response = await fetch(DISCORD_ENDPOINT, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            modalStatus.textContent = "âœ… ì œë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.";
                            reportForm.reset();
                            setTimeout(() => modal.classList.remove('show'), 3000);
                        } else {
                            modalStatus.textContent = `âŒ ì „ì†¡ ì‹¤íŒ¨: Webhook ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${response.status})`;
                        }
                    } catch (error) {
                        modalStatus.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                    }
                });
            }
        });

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
        function getProxyImage(url) {
            if (!url) return 'images/smile_Ramona.webp';
            url = url.trim();
            if (url.startsWith('//')) { url = 'https:' + url; }
            if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
                return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
            }
            return url;
        }

        async function renderCodeLinks(urls, container) {
            const warningHtml = '<div class="code-warning-text">ë§Œë£Œëœ êµí™˜ ì½”ë“œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
            container.insertAdjacentHTML('beforebegin', warningHtml);
            const codeBox = document.createElement('div');
            codeBox.className = 'text-link-box';
            let codeContentHTML = '';

            urls.forEach(item => {
                let codeLine = '', codeString = '';
                if (typeof item === 'object') {
                    codeLine = `<b>${item.title}</b>: ${item.desc || item.url || ''}`;
                    codeString = item.desc || item.title;
                } else {
                    codeLine = item;
                    codeString = item;
                }
                const cleanedCode = codeString.replace(/\\n/g, ' ').trim();
                codeContentHTML += `<div class="code-line" onclick="copyCodeToClipboard('${cleanedCode}', this)">${codeLine}</div>`;
            });
            codeBox.innerHTML = codeContentHTML;
            container.appendChild(codeBox);
        }

        function createLinkCardInstant(data, container) {
            try {
                const domain = new URL(data.url).hostname;
                const safeImage = getProxyImage(data.image);
                const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>
                </a>`;
                container.insertAdjacentHTML('beforeend', html);
            } catch (e) { console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e); }
        }

        async function createLinkCardFromAPI(url, container) {
            const cardWrap = document.createElement('div');
            cardWrap.className = 'skeleton skeleton-card';
            cardWrap.innerHTML = `<div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div>`;
            container.appendChild(cardWrap);
            try {
                const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
                const res = await fetch(apiUrl);
                const json = await res.json();
                if (json.status === 'success') {
                    const data = json.data;
                    const safeImage = getProxyImage(data.image?.url);
                    cardWrap.className = 'notion-bookmark';
                    cardWrap.innerHTML = '';
                    const linkEl = document.createElement('a');
                    linkEl.href = url; linkEl.target = "_blank";
                    linkEl.className = "notion-bookmark"; linkEl.style.width = "100%";
                    linkEl.innerHTML = `
                    <div class="bookmark-content">
                        <div><div class="bookmark-title">${data.title || url}</div><div class="bookmark-desc">${data.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div></div>
                        <div class="bookmark-url">ğŸ”— ${data.publisher || 'Link'}</div>
                    </div>
                    <div class="bookmark-image"><img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" onerror="this.onerror=null; this.src='images/smile_Ramona.webp';"></div>`;
                    container.replaceChild(linkEl, cardWrap);
                } else { throw new Error("API Fail"); }
            } catch (e) {
                cardWrap.className = 'notion-bookmark';
                cardWrap.innerHTML = `<a href="${url}" target="_blank" style="padding:20px; color:#fff; text-decoration:none; width:100%; display:block;"><div style="font-weight:bold; margin-bottom:5px;">${url}</div><div style="font-size:0.8em; color:#aaa;">(ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ - ì½˜ì†” í™•ì¸)</div></a>`;
            }
        }

        // Discord Webhook ì „ì†¡ í•¨ìˆ˜
        async function sendToDiscord(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const payload = {
                content: `**ë²„ê·¸ ì‹ ê³ **\nì¶œì²˜ URL: ${formData.get('source_url')}\në‚´ìš©: ${formData.get('content')}`
            };

            try {
                await fetch(CONFIG.DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!');
                document.getElementById('report-modal').classList.remove('show');
                form.reset();
            } catch (error) {
                alert('ì „ì†¡ ì‹¤íŒ¨: ' + error.message);
            }
        }
    </script>

    <!-- Floating ì‹ ê³  ë²„íŠ¼ -->
    <button class="floating-report-btn" onclick="document.getElementById('report-modal').classList.add('show')"
        title="ë²„ê·¸ ì‹ ê³ ">
        ğŸš¨
    </button>
</body>

</html>