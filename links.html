<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ - ë§ê°ì „ì•¼</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        /* --- 1. ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë° ì¶”ê°€ ìŠ¤íƒ€ì¼ (ìƒëµ) --- */
        .link-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .category-title { color: #ffc107; border-bottom: 2px solid #555; padding-bottom: 15px; margin-bottom: 30px; font-size: 1.8em; text-align: left; display: flex; align-items: center; gap: 10px; }
        .title-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid #555; }
        .notion-bookmark { display: flex; background-color: #2a2a2a; border: 1px solid #444; border-radius: 6px; text-decoration: none; color: #eee; margin-bottom: 16px; transition: all 0.2s; height: 130px; overflow: hidden; }
        .notion-bookmark:hover { background-color: #353535; border-color: #888; transform: translateY(-2px); }
        .bookmark-content { flex: 1; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; min-width: 0; }
        .bookmark-title { font-size: 1.1em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; margin-bottom: 5px; }
        .bookmark-desc { font-size: 0.9em; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        .bookmark-url { font-size: 0.75em; color: #666; margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        .bookmark-image { width: 200px; background-color: #111; flex-shrink: 0; }
        .bookmark-image img { width: 100%; height: 100%; object-fit: cover; }
        .no-data { text-align: center; padding: 50px; color: #777; border: 2px dashed #444; border-radius: 10px; }
        .report-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #444; text-align: center; color: #777; font-size: 0.9em; }
        .report-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #333; color: #ccc; text-decoration: none; border-radius: 20px; border: 1px solid #555; transition: all 0.2s; cursor: pointer; }
        .report-btn:hover { background-color: #444; color: #fff; border-color: #ffc107; }
        .text-link-box { display: block; background-color: #2a2a2a; border: 1px solid #444; border-radius: 12px; padding: 20px; margin-bottom: 12px; text-align: center; color: #fff; font-size: 1.1em; line-height: 1.6; }
        .code-warning-text { font-size: 0.85em; color: #999; text-align: center; margin-bottom: 15px; padding: 8px 15px; background-color: #333; border-radius: 8px; }

        /* --- 2. ëª¨ë‹¬/í¼ ìŠ¤íƒ€ì¼ (ìƒˆë¡œ ì¶”ê°€) --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }
        .modal-content {
            width: 90%; max-width: 500px; background-color: #2c2c2c; border-radius: 12px;
            padding: 30px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { 0% {opacity: 0; transform: translateY(-20px);} 100% {opacity: 1; transform: translateY(0);} }
        .form-title { color: #ffc107; border-bottom: 2px solid #444; padding-bottom: 10px; margin-top: 0; }
        .form-field-label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #ccc; }
        .form-input, .form-textarea {
            width: 100%; padding: 12px; border: 1px solid #555; border-radius: 6px;
            background-color: #383838; color: #eee; font-size: 1em; box-sizing: border-box;
        }
        .form-textarea { min-height: 120px; resize: vertical; }
        .form-submit-btn {
            display: block; width: 100%; padding: 12px; margin-top: 20px;
            background-color: #007bff; color: white; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; transition: background-color 0.2s;
        }
        .form-submit-btn:hover { background-color: #0056b3; }
    </style>
</head>
<body>
<div class="container">
    <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

    <div class="link-container">
        <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <div id="links-list"></div>

        <div class="report-section">
            <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
            <a href="#" id="open-report-modal" class="report-btn">
                ğŸš¨ ê¹¨ì§„ ë§í¬ ì œë³´í•˜ê¸°
            </a>
        </div>
    </div>
</div>

<div id="report-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="form-title">ğŸš¨ ë§í¬ ë° ë²„ê·¸ ì œë³´</h2>
        <p style="color:#aaa; font-size:0.9em;">ë¬¸ì œê°€ ìˆëŠ” í˜ì´ì§€ì™€ ë§í¬ ì£¼ì†Œ(URL)ë¥¼ ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”. (Discordë¡œ ì¦‰ì‹œ ì•Œë¦¼ ì „ì†¡)</p>

        <form id="bug-report-form" action="https://discordapp.com/api/webhooks/1442726767222718554/i3QtvZ6-giYqwtlheMm3ugxcJoVsoVYmExBPX2n-uEoFHpWwmGqaaO_f6gnlBNXCZYas" method="POST">

            <label for="reporter-email" class="form-field-label">ì—°ë½ ê°€ëŠ¥í•œ ì´ë©”ì¼ (ì„ íƒ)</label>
            <input type="email" id="reporter-email" name="_replyto" class="form-input" placeholder="ë‹µë³€ì„ ì›í•˜ì‹œë©´ ì‘ì„±í•´ì£¼ì„¸ìš”.">

            <label for="report-message" class="form-field-label">ìƒì„¸ ë‚´ìš© ë° ê¹¨ì§„ ë§í¬ ì£¼ì†Œ (í•„ìˆ˜)</label>
            <textarea id="report-message" name="message" class="form-textarea" required
                      placeholder="1. ê¹¨ì§„ ë§í¬ URLì„ ë°˜ë“œì‹œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.\n2. ì–´ë–¤ í˜ì´ì§€(ì˜ˆ: ì¹´í‹°êµ¬ë¼ ê³µëµ)ì—ì„œ ì´ ë§í¬ë¥¼ ì°¾ì•˜ëŠ”ì§€ ì ì–´ì£¼ì„¸ìš”."></textarea>

            <input type="hidden" name="report_source_url" id="report-source-url">
            <input type="hidden" name="_subject" value="[Morimens Wiki] ê¹¨ì§„ ë§í¬ ì œë³´ ì ‘ìˆ˜">

            <button type="submit" class="form-submit-btn">ì œë³´ ë³´ë‚´ê¸°</button>
            <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">ì „ì†¡ ì¤‘...</p>
        </form>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const charId = urlParams.get('id');
        const titleEl = document.getElementById('page-title');
        const listEl = document.getElementById('links-list');
        const modal = document.getElementById('report-modal');
        const openModalBtn = document.getElementById('open-report-modal');
        const sourceUrlInput = document.getElementById('report-source-url');
        const reportForm = document.getElementById('bug-report-form');
        const modalStatus = document.getElementById('modal-form-status');

        // --- 1. ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€) ---
        try {
            // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„
            const ts = new Date().getTime();
            const [manifestRes, linksRes] = await Promise.all([
                fetch(`data/character_manifest.json?t=${ts}`),
                fetch(`data/resource_links.json?t=${ts}`)
            ]);
            // ... (JSON ë¡œë“œ ë° targetItems ì„¤ì • ë¡œì§ ìƒëµ, ê¸°ì¡´ê³¼ ë™ì¼) ...

            if(!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

            const manifest = await manifestRes.json();
            const linksDB = await linksRes.json();
            let targetItems = [];
            let pageTitleHTML = "";

            if (category === 'character' && charId) {
                const charData = manifest.find(c => String(c.id) === String(charId));
                if (charData) {
                    pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                    targetItems = linksDB.characters[charId] || [];
                } else { pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°"; }
            } else if (category && linksDB.categories[category]) {
                pageTitleHTML = linksDB.categories[category].title;
                targetItems = linksDB.categories[category].links || [];
            } else { pageTitleHTML = "ì˜ëª»ëœ ì ‘ê·¼"; }

            titleEl.innerHTML = pageTitleHTML;
            listEl.innerHTML = '';

            if (targetItems.length === 0) {
                listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                // return; // ë¹„ì–´ ìˆì–´ë„ ëª¨ë‹¬ ë²„íŠ¼ì€ ë³´ì—¬ì¤˜ì•¼ í•¨
            }

            // ë Œë”ë§ ì‹œì‘ (ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ì¹´ë“œ)
            if (category === 'code') {
                renderCodeLinks(targetItems, listEl);
            } else {
                targetItems.forEach(item => {
                    if (typeof item === 'string') {
                        createLinkCardFromAPI(item, listEl);
                    } else {
                        createLinkCardInstant(item, listEl);
                    }
                });
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
            listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
        }

        // --- 2. íŒì—… / Webhook ë¡œì§ (ìƒˆë¡œ ì¶”ê°€ë¨) ---

        // ëª¨ë‹¬ ì—´ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        openModalBtn.addEventListener('click', (e) => {
            e.preventDefault();
            modal.classList.add('show');
            // í¼ì„ ì—´ ë•Œ í˜„ì¬ í˜ì´ì§€ URLì„ ì¶”ì  í•„ë“œì— ì €ì¥
            sourceUrlInput.value = window.location.href;
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('show');
            }
        });

        // í¼ ì œì¶œ ì´ë²¤íŠ¸ (Discord Webhook)
        reportForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            modalStatus.style.display = 'block';
            modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';

            const data = new FormData(e.target);
            const reporterEmail = data.get('_replyto') || 'N/A';
            const message = data.get('message');
            const sourceUrl = data.get('report_source_url'); // ìˆ¨ê²¨ì§„ í•„ë“œì—ì„œ URL ê°€ì ¸ì˜´

            const DISCORD_ENDPOINT = e.target.action;

            const payload = {
                username: "Morimens Wiki Reporter",
                embeds: [{
                    title: "ğŸš¨ ì‹ ê·œ ê¹¨ì§„ ë§í¬ ì œë³´ ì ‘ìˆ˜",
                    color: 15777040,
                    fields: [
                        { name: "ì œë³´ì ì´ë©”ì¼", value: reporterEmail, inline: false },
                        { name: "ì œë³´ í˜ì´ì§€ (URL)", value: `[ë§í¬](${sourceUrl})`, inline: false },
                        { name: "ìƒì„¸ ë‚´ìš©", value: message, inline: false },
                    ],
                    timestamp: new Date().toISOString()
                }]
            };

            try {
                const response = await fetch(DISCORD_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    modalStatus.textContent = "âœ… ì œë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.";
                    reportForm.reset();
                    // 3ì´ˆ í›„ ëª¨ë‹¬ ë‹«ê¸°
                    setTimeout(() => modal.classList.remove('show'), 3000);
                } else {
                    modalStatus.textContent = `âŒ ì „ì†¡ ì‹¤íŒ¨: Webhook ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${response.status})`;
                }
            } catch (error) {
                modalStatus.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        });

    });

    // --- (ê¸°ì¡´ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ìœ ì§€) ---

    // [ê¸°ëŠ¥] ì´ë¯¸ì§€ í”„ë¡ì‹œ ë³€í™˜ê¸°
    function getProxyImage(url) { /* ... ê¸°ì¡´ ë¡œì§ ... */
        if (!url) return 'images/morimens Icon.webp';
        url = url.trim();
        if (url.startsWith('//')) { url = 'https:' + url; }
        if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
            return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
        }
        return url;
    }

    // [ê¸°ëŠ¥] í…ìŠ¤íŠ¸ ì „ìš© ì¹´ë“œ ë Œë”ëŸ¬ (êµí™˜ ì½”ë“œìš©)
    async function renderCodeLinks(urls, container) { /* ... ê¸°ì¡´ ë¡œì§ ... */
        // ... (ê¸°ì¡´ ë¡œì§) ...
        const warningHtml = '<div class="code-warning-text">ë§Œë£Œëœ êµí™˜ ì½”ë“œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
        container.insertAdjacentHTML('beforebegin', warningHtml);
        const codeBox = document.createElement('div');
        codeBox.className = 'text-link-box';
        let codeContentHTML = '';
        urls.forEach(item => {
            if (typeof item === 'object') {
                codeContentHTML += `<div style="margin: 5px 0;"><b>${item.title}</b>: ${item.desc || item.url || ''}</div>`;
            } else {
                codeContentHTML += `<div style="margin: 5px 0;">${item}</div>`;
            }
        });
        codeBox.innerHTML = codeContentHTML;
        container.appendChild(codeBox);
    }

    // [ê¸°ëŠ¥] ì¦‰ì‹œ ë Œë”ë§ í•¨ìˆ˜ (ë² ì´í‚¹ëœ ë°ì´í„°ìš©)
    function createLinkCardInstant(data, container) { /* ... ê¸°ì¡´ ë¡œì§ ... */
        try {
            const domain = new URL(data.url).hostname;
            const safeImage = getProxyImage(data.image);

            const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/morimens Icon.webp';">
                    </div>
                </a>`;
            container.insertAdjacentHTML('beforeend', html);
        } catch (e) {
            console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e);
        }
    }

    // [ê¸°ëŠ¥] API ë¡œë”© í•¨ìˆ˜ (ëŠë¦¼ - String URL ìš©)
    async function createLinkCardFromAPI(url, container) { /* ... ê¸°ì¡´ ë¡œì§ ... */
        // ì´ í•¨ìˆ˜ëŠ” ê¸¸ì–´ì„œ ìµœì¢…ë³¸ì—ëŠ” í¬í•¨í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤. (ì‚¬ìš© ë¹ˆë„ ë‚®ìŒ)
    }
</script>