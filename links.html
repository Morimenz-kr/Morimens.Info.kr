<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="icon" type="image/webp" href="images/smile_Ramona.webp">
    <meta charset="UTF-8">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://morimenz-kr.github.io/Morimens.Info.kr/">
    <meta property="og:title" content="ë¯¸ì‚¬ê·¸ ëŒ€í•™ í•œêµ­ ìº í¼ìŠ¤">
    <meta property="og:description" content="ìºë¦­í„° ê³µëµ, í™˜ëª½ì‹¬ì , ìœµì¬ê¸ˆêµ¬, ì¿ í° ë“± ë¯¸ì‚¬ê·¸ ëŒ€í•™ì˜ ëª¨ë“  ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://morimenz-kr.github.io/Morimens.Info.kr/images/background.png">

    <script src="config/config.js"></script>
    <script>
        loadCSS('css/common.css');
        loadCSS('css/components.css');
        loadCSS('css/pages/links.css');
        loadCSS('css/responsive.css');
    </script>
    <style>
        /* ì¶”ê°€ëœ ë²„íŠ¼ì˜ ìŠ¤íƒ€ì¼ */
        .party-link-btn {
            display: block;
            width: 100%;
            padding: 15px 10px;
            margin: 15px 0 25px 0;
            background-color: #f7a115; /* ê°•ì¡° ìƒ‰ìƒ */
            color: #1a1a1a;
            font-weight: bold;
            text-align: center;
            border-radius: 8px;
            text-decoration: none;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s;
        }
        .party-link-btn:hover {
            background-color: #e59400;
        }
        .party-credit-text {
            display: block;
            font-size: 0.8em;
            color: #aaa;
            text-align: center;
            margin-top: 10px;
            padding-bottom: 20px;
        }
        /* ê¸°ì¡´ .report-btn ìŠ¤íƒ€ì¼ */
        .report-btn {
            display: block;
            width: 100%;
            padding: 12px 0;
            background-color: #333;
            color: #ccc;
            text-align: center;
            border-radius: 4px;
            text-decoration: none;
            border: 1px solid #555;
            cursor: pointer;
            font-size: 0.95em;
            margin-top: 10px;
        }
        .report-btn:hover {
            background-color: #444;
            color: #fff;
        }
    </style>
</head>

<body>

<div class="container" style="position: relative; z-index: 2;">
    <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

    <div class="link-container">
        <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>

        <div id="party-link-slot"></div>
        <div id="links-list"></div>

        <div class="report-section">
            <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
            <button id="open-report-modal" class="report-btn">
                ğŸš¨ ë²„ê·¸/í”¼ë“œë°± ì œë³´í•˜ê¸°
            </button>
            <span id="party-credit-slot" class="party-credit-text" style="display:none;">
                'ìœµì¬ ê¸ˆêµ¬ íŒŒí‹° í¸ì„±' ê¸°ëŠ¥ì€ ë§ê°ì „ì•¼ ì±„ë„ì˜ 'í”Œë¦°ì˜ ì¡°ìˆ˜'ë‹˜ì´ ì œì‘í•˜ì‹  ì‚¬ì´íŠ¸ë¡œ ì—°ê²°ë©ë‹ˆë‹¤.
            </span>
        </div>
    </div>
</div>

<div id="report-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="form-title">ğŸš¨ ë²„ê·¸ ì œë³´ or í”¼ë“œë°±</h2>
        <p style="color:#aaa; font-size:0.9em;">ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. ê°œë°œìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p>

        <form id="bug-report-form" action="javascript:void(0);" onsubmit="sendToDiscord(event)" method="POST">

            <label for="reporter-email" class="form-field-label">íŒ¨ì¹˜ë…¸íŠ¸ì— ì˜¬ë¼ê°ˆ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
            <input type="text" id="reporter-email" name="_replyto" class="form-input"
                   placeholder="íŒ¨ì¹˜ë…¸íŠ¸ì— ì–¸ê¸‰ì„ ì›í•˜ì‹œë©´ ì ì–´ì£¼ì„¸ìš”.">

            <label for="report-message" class="form-field-label">
                ì œë³´í•  ë‚´ìš© (ë²„ê·¸ or í”¼ë“œë°±) (í•„ìˆ˜)
                <span style="display:block; margin-top:5px; font-size:0.9em; color:#ff9f43; font-weight:normal;">
                        â€» íŠ¹ì • ê²Œì‹œê¸€/ì •ë³´ ê´€ë ¨ ì œë³´ë¼ë©´, <u>í•´ë‹¹ ê¸€ì˜ ë§í¬</u>ë¥¼ ë³¸ë¬¸ì— ê¼­ ì ì–´ì£¼ì„¸ìš”!
                    </span>
            </label>
            <textarea id="report-message" name="message" class="form-textarea" required
                      placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. (ì˜ˆ: 'XX ìºë¦­í„° ê³µëµ ë§í¬ê°€ ì•ˆ ì—´ë ¤ìš”', 'ì´ ë§í¬(URL) ì ‘ì†ì´ ì•ˆ ë¼ìš”')"></textarea>

            <input type="hidden" name="report_source_url" id="report-source-url">
            <button type="submit" class="form-submit-btn">ì œë³´ ë³´ë‚´ê¸°</button>
            <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">ì „ì†¡ ì¤‘...</p>
        </form>
    </div>
</div>

<script>
    // --- ê¸°ëŠ¥ ë¡œì§ ---
    function openReportModal() {
        const modal = document.getElementById('report-modal');
        const sourceUrlInput = document.getElementById('report-source-url');
        const modalStatus = document.getElementById('modal-form-status');

        if (modalStatus) {
            modalStatus.style.display = 'none';
            modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';
            modalStatus.style.color = '#ffc107';
        }
        if (sourceUrlInput) { sourceUrlInput.value = window.location.href; }
        modal.classList.add('show');
    }

    async function sendToDiscord(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const modalStatus = document.getElementById('modal-form-status');
        const modal = document.getElementById('report-modal');

        if (modalStatus) {
            modalStatus.style.display = 'block';
            modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';
            modalStatus.style.color = '#ffc107';
        }

        const reporterEmail = formData.get('_replyto') || 'ìµëª…(Anonymous)';
        const message = formData.get('message');
        const sourceUrl = formData.get('report_source_url') || window.location.href;

        const payload = {
            username: "Morimens Wiki Bot",
            embeds: [{
                title: "ğŸ“© ìƒˆë¡œìš´ ì œë³´ê°€ ë„ì°©í–ˆìŠµë‹ˆë‹¤!",
                description: "ìœ„í‚¤ì—ì„œ ìœ ì € í”¼ë“œë°±/ë²„ê·¸ ì œë³´ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.",
                color: 0xFF9F43,
                fields: [
                    { name: "ğŸ‘¤ ì œë³´ì", value: `\`${reporterEmail}\``, inline: true },
                    { name: "ğŸ“ ë°œìƒ í˜ì´ì§€", value: `[ë°”ë¡œê°€ê¸°(Click)](${sourceUrl})`, inline: true },
                    { name: "ğŸ“ ìƒì„¸ ë‚´ìš©", value: `>>> ${message}`, inline: false }
                ],
                footer: { text: "Morimens Wiki Report System" },
                timestamp: new Date().toISOString()
            }]
        };

        try {
            const webhookUrl = (typeof CONFIG !== 'undefined') ? CONFIG.DISCORD_WEBHOOK_URL : '';
            if(!webhookUrl) throw new Error("Config Error");

            await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (modalStatus) {
                modalStatus.textContent = "âœ… ì „ì†¡ ì™„ë£Œ! ê°ì‚¬í•©ë‹ˆë‹¤.";
                modalStatus.style.color = "#2ecc71";
            }
            form.reset();
            setTimeout(() => {
                modal.classList.remove('show');
                if (modalStatus) {
                    modalStatus.style.display = 'none';
                    modalStatus.textContent = 'ì „ì†¡ ì¤‘...';
                }
            }, 1500);
        } catch (error) {
            console.error(error);
            if (modalStatus) {
                modalStatus.textContent = 'âŒ ì„¤ì • ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ì…ë‹ˆë‹¤.';
                modalStatus.style.color = "#e74c3c";
            }
        }
    }

    // ğŸš© ì „ì—­ ë³µì‚¬ í•¨ìˆ˜
    function copyCodeToClipboard(text, element) {
        if (!navigator.clipboard) {
            alert("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            element.classList.add('copied');
            const originalText = element.innerHTML;
            element.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
            setTimeout(() => {
                element.classList.remove('copied');
                element.innerHTML = originalText;
            }, 800);
        }).catch(err => {
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            alert('ë³µì‚¬ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const charId = urlParams.get('id');
        const titleEl = document.getElementById('page-title');
        const listEl = document.getElementById('links-list');

        const modal = document.getElementById('report-modal');
        const openModalBtn = document.getElementById('open-report-modal');

        if (openModalBtn) {
            openModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                openReportModal();
            });
        }
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });
        }

        // 1. ì¹´í…Œê³ ë¦¬ë³„ í´ë˜ìŠ¤ ì¶”ê°€
        if (category) {
            document.body.classList.add(`category-${category}`);

            // =======================================================
            // â­ ì‚¬ìš©ì ìš”ì²­: 'ìœµì¬ê¸ˆêµ¬' í˜ì´ì§€ì¼ ë•Œ íŒŒí‹° ì°¾ê¸° ë²„íŠ¼ ì‚½ì… ë¡œì§
            if (category === 'weapon') {
                const partySlot = document.getElementById('party-link-slot');
                const partyCredit = document.getElementById('party-credit-slot');

                // ë‚´ë¶€ ì‹œë®¬ë ˆì´í„° ë²„íŠ¼ (ì‹ ê·œ) + ì™¸ë¶€ ë§í¬ ë²„íŠ¼ (ê¸°ì¡´)
                const partyButtonHTML = `
                    <a href="party_builder.html" class="party-link-btn" style="background-color: #3498db; color: #fff; margin-bottom: 10px;">
                        ğŸ› ï¸ ìœµì¬ ê¸ˆêµ¬ íŒŒí‹° ì‹œë®¬ë ˆì´í„° ì‹¤í–‰ (Beta)
                    </a>
                `;
                partySlot.innerHTML = partyButtonHTML;

                partyCredit.style.display = 'block';
            }
            // =======================================================
        }

        try {
            const ts = new Date().getTime();
            const [manifestRes, linksRes] = await Promise.all([
                fetch(`data/character_manifest.json?t=${ts}`),
                fetch(`data/resource_links.json?t=${ts}`)
            ]);

            if (!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

            const manifest = await manifestRes.json();
            const linksDB = await linksRes.json();
            let targetItems = [];
            let pageTitleHTML = "";

            // 2. ë°ì´í„° ë¡œë“œ ë¶„ê¸° ì²˜ë¦¬
            if (category === 'character' && charId) {
                const charData = manifest.find(c => String(c.id) === String(charId));
                if (charData) {
                    pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                    targetItems = linksDB.characters[charId] || [];
                } else {
                    pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°";
                }
            } else if (category && linksDB.categories[category]) {
                pageTitleHTML = linksDB.categories[category].title;
                targetItems = linksDB.categories[category].links || [];
            } else {
                pageTitleHTML = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜ì´ì§€";
                targetItems = [];
            }

            titleEl.innerHTML = pageTitleHTML;
            listEl.innerHTML = '';

            if (targetItems.length === 0) {
                listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            }

            // 3. ë Œë”ë§ ë¶„ê¸°
            if (category === 'code') {
                renderCodeLinks(targetItems, listEl);
            } else {
                targetItems.forEach(item => {
                    if (typeof item === 'string') {
                        createLinkCardFromAPI(item, listEl);
                    } else {
                        createLinkCardInstant(item, listEl);
                    }
                });
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
            listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
        }
    });

    // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
    function getProxyImage(url) {
        if (!url) return 'images/smile_Ramona.webp';
        url = url.trim();
        if (url.startsWith('//')) { url = 'https:' + url; }
        if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
            return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
        }
        return url;
    }

    function renderCodeLinks(items, container) {
        container.innerHTML = ''; // ì´ˆê¸°í™”

        // 1. ë°ì´í„° ë¶„ë¥˜
        const permanent = items.filter(item => !item.expiry);
        const temporary = items.filter(item => item.expiry && new Date(item.expiry) >= new Date().setHours(0,0,0,0));

        // D-Day ê³„ì‚° í•¨ìˆ˜
        const getDDay = (dateStr) => {
            const diff = new Date(dateStr) - new Date();
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
            return days === 0 ? "ì˜¤ëŠ˜ ë§Œë£Œ" : `${days}ì¼ ë‚¨ìŒ`;
        };

        // ì¹´ë“œ ìƒì„± ë„ìš°ë¯¸
        const createCard = (item, isTemp) => `
        <div class="code-card">
            <div class="code-details">
                <span class="code-title">${item.title}</span>
                <span class="code-reward">${item.desc || 'ë³´ìƒ ì •ë³´ ì—†ìŒ'}</span>
                ${isTemp ? `<div class="code-timer">â³ ${getDDay(item.expiry)}</div>` : ''}
            </div>
            <button class="code-copy-btn" onclick="copyCodeToClipboard('${item.title}', this)">ë³µì‚¬</button>
        </div>
    `;

        // 2. ê¸°ê°„ í•œì • ì½”ë“œ ë Œë”ë§
        if (temporary.length > 0) {
            container.insertAdjacentHTML('beforeend', '<div class="section-label">ğŸ“… ê¸°ê°„ í•œì • ì½”ë“œ</div>');
            const tempGroup = document.createElement('div');
            tempGroup.className = 'code-card-container';
            temporary.forEach(item => tempGroup.insertAdjacentHTML('beforeend', createCard(item, true)));
            container.appendChild(tempGroup);
        }

        // 3. ìƒì‹œ ì½”ë“œ ë Œë”ë§
        if (permanent.length > 0) {
            container.insertAdjacentHTML('beforeend', '<div class="section-label">â™¾ï¸ ìƒì‹œ ì½”ë“œ</div>');
            const permGroup = document.createElement('div');
            permGroup.className = 'code-card-container';
            permanent.forEach(item => permGroup.insertAdjacentHTML('beforeend', createCard(item, false)));
            container.appendChild(permGroup);
        }
    }

    function createLinkCardInstant(data, container) {
        try {
            let domain = 'link';
            try { if(data.url) domain = new URL(data.url).hostname; } catch(e) {}
            const safeImage = getProxyImage(data.image);

            const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title || 'ì œëª© ì—†ìŒ'}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px; vertical-align:middle;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>
                </a>`;
            container.insertAdjacentHTML('beforeend', html);
        } catch (e) { console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e); }
    }

    async function createLinkCardFromAPI(url, container) {
        const cardWrap = document.createElement('div');
        cardWrap.className = 'skeleton skeleton-card';
        cardWrap.innerHTML = `<div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div>`;
        container.appendChild(cardWrap);
        try {
            const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
            const res = await fetch(apiUrl);
            const json = await res.json();

            if (json.status === 'success') {
                const data = json.data;
                const safeImage = getProxyImage(data.image?.url);

                cardWrap.className = 'notion-bookmark';
                cardWrap.innerHTML = '';

                const linkEl = document.createElement('a');
                linkEl.href = url;
                linkEl.target = "_blank";
                linkEl.className = "notion-bookmark";
                linkEl.style.width = "100%";

                linkEl.innerHTML = `
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title || url}</div>
                            <div class="bookmark-desc">${data.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        </div>
                        <div class="bookmark-url">ğŸ”— ${data.publisher || 'Link'}</div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>`;

                container.replaceChild(linkEl, cardWrap);
            } else { throw new Error("API Fail"); }
        } catch (e) {
            cardWrap.className = 'notion-bookmark';
            cardWrap.innerHTML = `<a href="${url}" target="_blank" style="padding:15px; color:#fff; text-decoration:none; width:100%; display:block;"><div style="font-weight:bold; margin-bottom:5px; word-break:break-all;">${url}</div><div style="font-size:0.8em; color:#aaa;">(ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì‹¤íŒ¨)</div></a>`;
        }
    }
</script>

<button class="floating-report-btn" onclick="openReportModal()" title="ë²„ê·¸ ì‹ ê³ ">
    ğŸš¨
</button>
</body>
</html>