<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ - ë§ê°ì „ì•¼</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        /* --- ìŠ¤íƒ€ì¼ (ê¸°ì¡´ê³¼ ë™ì¼) --- */
        .link-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .category-title { color: #ffc107; border-bottom: 2px solid #555; padding-bottom: 15px; margin-bottom: 30px; font-size: 1.8em; text-align: left; display: flex; align-items: center; gap: 10px; }
        .title-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid #555; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .notion-bookmark { display: flex; background-color: #2a2a2a; border: 1px solid #444; border-radius: 6px; text-decoration: none; color: #eee; margin-bottom: 16px; transition: all 0.2s; height: 130px; overflow: hidden; }
        .notion-bookmark:hover { background-color: #353535; border-color: #888; transform: translateY(-2px); }

        /* ë‚´ìš© ì˜ì—­ */
        .bookmark-content { flex: 1; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; min-width: 0; }
        .bookmark-title { font-size: 1.1em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; margin-bottom: 5px; }
        .bookmark-desc { font-size: 0.9em; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        .bookmark-url { font-size: 0.75em; color: #666; margin-top: 8px; display: flex; align-items: center; gap: 5px; }

        /* ì´ë¯¸ì§€ ì˜ì—­ */
        .bookmark-image { width: 200px; background-color: #111; flex-shrink: 0; }
        .bookmark-image img { width: 100%; height: 100%; object-fit: cover; }

        /* ìŠ¤ì¼ˆë ˆí†¤ UI */
        .skeleton { background: linear-gradient(90deg, #2a2a2a 25%, #333 50%, #2a2a2a 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: 4px; }
        @keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .skeleton-card { height: 130px; margin-bottom: 16px; border-radius: 6px; display: flex; border: 1px solid #333; }
        .skeleton-content { flex: 1; padding: 16px; }
        .skeleton-title { height: 20px; width: 60%; margin-bottom: 10px; }
        .skeleton-desc { height: 14px; width: 90%; margin-bottom: 6px; }
        .skeleton-img { width: 200px; height: 100%; }

        @media (max-width: 600px) {
            .notion-bookmark, .skeleton-card { height: auto; flex-direction: column-reverse; }
            .bookmark-image, .skeleton-img { width: 100%; height: 140px; }
        }

        .no-data { text-align: center; padding: 50px; color: #777; border: 2px dashed #444; border-radius: 10px; }

        /* ì œë³´ ë²„íŠ¼ */
        .report-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #444; text-align: center; color: #777; font-size: 0.9em; }
        .report-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #333; color: #ccc; text-decoration: none; border-radius: 20px; border: 1px solid #555; transition: all 0.2s; }
        .report-btn:hover { background-color: #444; color: #fff; border-color: #ffc107; }
    </style>
</head>
<body>
<div class="container">
    <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

    <div class="link-container">
        <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <div id="links-list">
            <div class="skeleton skeleton-card"><div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div></div>
        </div>

        <div class="report-section">
            <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
            <a href="mailto:admin@example.com?subject=[ë§ê°ì „ì•¼] ë§í¬ ì œë³´" class="report-btn">ğŸš¨ ê¹¨ì§„ ë§í¬ ì œë³´í•˜ê¸°</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const charId = urlParams.get('id');
        const titleEl = document.getElementById('page-title');
        const listEl = document.getElementById('links-list');

        try {
            const [manifestRes, linksRes] = await Promise.all([
                fetch('data/character_manifest.json'),
                fetch('data/resource_links.json')
            ]);

            if(!manifestRes.ok || !linksRes.ok) throw new Error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨");

            const manifest = await manifestRes.json();
            const linksDB = await linksRes.json();

            let targetItems = []; 
            let pageTitleHTML = "";

            if (category === 'character' && charId) {
                const charData = manifest.find(c => String(c.id) === String(charId));
                if (charData) {
                    pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                    targetItems = linksDB.characters[charId] || [];
                } else {
                    pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°";
                }
            } else if (category && linksDB.categories[category]) {
                pageTitleHTML = linksDB.categories[category].title;
                targetItems = linksDB.categories[category].links || [];
            } else {
                pageTitleHTML = "ì˜ëª»ëœ ì ‘ê·¼";
            }

            titleEl.innerHTML = pageTitleHTML;
            listEl.innerHTML = ''; 

            if (targetItems.length === 0) {
                listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                return;
            }

            targetItems.forEach(item => {
                if (typeof item === 'string') {
                    createLinkCardFromAPI(item, listEl);
                } else {
                    createLinkCardInstant(item, listEl);
                }
            });

        } catch (error) {
            console.error(error);
            titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
            listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
        }
    });

    // ğŸš© ì´ë¯¸ì§€ í”„ë¡ì‹œ ì²˜ë¦¬ í•¨ìˆ˜ (í•µì‹¬!)
    function getProxyImage(url) {
        if (!url) return 'images/default_thumb.webp';
        // ì•„ì¹´ë¼ì´ë¸Œ(namu.la)ë‚˜ ë””ì‹œ ë“± ì™¸ë¶€ ì´ë¯¸ì§€ëŠ” wsrv.nl í”„ë¡ì‹œë¥¼ íƒœì›€
        if (url.includes('http') && (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside'))) {
            return `https://wsrv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp`;
        }
        return url;
    }

    // --- A. ì¦‰ì‹œ ë Œë”ë§ í•¨ìˆ˜ ---
    function createLinkCardInstant(data, container) {
        const domain = new URL(data.url).hostname;
        // í”„ë¡ì‹œ ì ìš©ëœ ì´ë¯¸ì§€ URL ê°€ì ¸ì˜¤ê¸°
        const safeImage = getProxyImage(data.image);

        const html = `
            <a href="${data.url}" target="_blank" class="notion-bookmark">
                <div class="bookmark-content">
                    <div>
                        <div class="bookmark-title">${data.title}</div>
                        <div class="bookmark-desc">${data.desc || ''}</div>
                    </div>
                    <div class="bookmark-url">
                        <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px;">
                        ${domain}
                    </div>
                </div>
                <div class="bookmark-image">
                    <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                         onerror="this.src='https://via.placeholder.com/200x130/333?text=No+Image'">
                </div>
            </a>`;
        container.insertAdjacentHTML('beforeend', html);
    }

    // --- B. API ë¡œë”© í•¨ìˆ˜ ---
    async function createLinkCardFromAPI(url, container) {
        const cardWrap = document.createElement('div');
        cardWrap.className = 'skeleton skeleton-card'; 
        cardWrap.innerHTML = `<div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div>`;
        container.appendChild(cardWrap);

        try {
            const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
            const res = await fetch(apiUrl);
            const json = await res.json();

            if (json.status === 'success') {
                const data = json.data;
                const safeImage = getProxyImage(data.image?.url); // ì—¬ê¸°ë„ í”„ë¡ì‹œ ì ìš©

                cardWrap.className = 'notion-bookmark';
                cardWrap.innerHTML = ''; 
                
                const linkEl = document.createElement('a');
                linkEl.href = url;
                linkEl.target = "_blank";
                linkEl.className = "notion-bookmark";
                linkEl.style.width = "100%";
                linkEl.innerHTML = `
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title || url}</div>
                            <div class="bookmark-desc">${data.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        </div>
                        <div class="bookmark-url">ğŸ”— ${data.publisher || 'Link'}</div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy"
                             onerror="this.src='https://via.placeholder.com/200x130/333?text=No+Image'">
                    </div>`;
                
                container.replaceChild(linkEl, cardWrap);
            } else { throw new Error("API Fail"); }
        } catch (e) {
            cardWrap.className = 'notion-bookmark';
            cardWrap.innerHTML = `<a href="${url}" target="_blank" style="padding:20px; color:#fff; text-decoration:none; width:100%; display:block;">
                <div style="font-weight:bold; margin-bottom:5px;">${url}</div>
                <div style="font-size:0.8em; color:#aaa;">(ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ - í´ë¦­í•´ì„œ ì´ë™)</div>
            </a>`;
        }
    }
</script>
</body>

</html>
