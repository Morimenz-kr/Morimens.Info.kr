<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ - ë§ê°ì „ì•¼</title>
    <link rel="stylesheet" href="css/index.css">
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .link-container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .category-title { color: #ffc107; border-bottom: 2px solid #555; padding-bottom: 15px; margin-bottom: 30px; font-size: 1.8em; text-align: left; display: flex; align-items: center; gap: 10px; }
        .title-thumb { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid #555; }
        .notion-bookmark { display: flex; background-color: #2a2a2a; border: 1px solid #444; border-radius: 6px; text-decoration: none; color: #eee; margin-bottom: 16px; transition: all 0.2s; height: 130px; overflow: hidden; }
        .notion-bookmark:hover { background-color: #353535; border-color: #888; transform: translateY(-2px); }
        .bookmark-content { flex: 1; padding: 16px; display: flex; flex-direction: column; justify-content: space-between; min-width: 0; }
        .bookmark-title { font-size: 1.1em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #fff; margin-bottom: 5px; }
        .bookmark-desc { font-size: 0.9em; color: #aaa; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.4; }
        .bookmark-url { font-size: 0.75em; color: #666; margin-top: 8px; display: flex; align-items: center; gap: 5px; }
        .bookmark-image { width: 200px; background-color: #111; flex-shrink: 0; }
        .bookmark-image img { width: 100%; height: 100%; object-fit: cover; }
        .no-data { text-align: center; padding: 50px; color: #777; border: 2px dashed #444; border-radius: 10px; }
        .report-section { margin-top: 40px; padding-top: 20px; border-top: 1px solid #444; text-align: center; color: #777; font-size: 0.9em; }
        .report-btn { display: inline-block; margin-top: 10px; padding: 8px 16px; background-color: #333; color: #ccc; text-decoration: none; border-radius: 20px; border: 1px solid #555; transition: all 0.2s; }
        .report-btn:hover { background-color: #444; color: #fff; border-color: #ffc107; }
    </style>
</head>
<body>
<div class="container">
    <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

    <div class="link-container">
        <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <div id="links-list"></div>

        <div class="report-section">
            <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
            <a href="mailto:admin@example.com?subject=[ë§ê°ì „ì•¼] ë§í¬ ì œë³´" class="report-btn">ğŸš¨ ê¹¨ì§„ ë§í¬ ì œë³´í•˜ê¸°</a>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const charId = urlParams.get('id');
        const titleEl = document.getElementById('page-title');
        const listEl = document.getElementById('links-list');

        try {
            // ìºì‹œ ë°©ì§€ìš© íƒ€ì„ìŠ¤íƒ¬í”„
            const ts = new Date().getTime();
            const [manifestRes, linksRes] = await Promise.all([
                fetch(`data/character_manifest.json?t=${ts}`),
                fetch(`data/resource_links.json?t=${ts}`)
            ]);

            if(!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

            const manifest = await manifestRes.json();
            const linksDB = await linksRes.json();

            let targetItems = [];
            let pageTitleHTML = "";

            // ì¹´í…Œê³ ë¦¬/ìºë¦­í„° íŒë³„ ë¡œì§
            if (category === 'character' && charId) {
                const charData = manifest.find(c => String(c.id) === String(charId));
                if (charData) {
                    pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                    targetItems = linksDB.characters[charId] || [];
                } else {
                    pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°";
                }
            } else if (category && linksDB.categories[category]) {
                pageTitleHTML = linksDB.categories[category].title;
                targetItems = linksDB.categories[category].links || [];
            } else {
                pageTitleHTML = "ì˜ëª»ëœ ì ‘ê·¼";
            }

            titleEl.innerHTML = pageTitleHTML;
            listEl.innerHTML = '';

            if (targetItems.length === 0) {
                listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                return;
            }

            targetItems.forEach(item => {
                // ê°ì²´ ë°ì´í„°ë§Œ ì²˜ë¦¬ (ë¬¸ìì—´ì€ API ì†ë„ ë¬¸ì œë¡œ ì¼ë‹¨ ì œì™¸)
                if (typeof item === 'object') {
                    createLinkCardInstant(item, listEl);
                }
            });

        } catch (error) {
            console.error(error);
            titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
            listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
        }
    });

    // ğŸš© [í•µì‹¬ 1] í”„ë¡ì‹œ ì„œë²„ ë³€ê²½ (wsrv.nl -> images.weserv.nl í’€ë„ë©”ì¸ ì‚¬ìš©)
    function getProxyImage(url) {
        if (!url) return 'images/smile_Ramona.webp'; // ì´ë¯¸ì§€ ì—†ìœ¼ë©´ ë¡œì»¬ ê¸°ë³¸ ì´ë¯¸ì§€ ë°˜í™˜

        url = url.trim();

        // í”„ë¡œí† ì½œ ì—†ëŠ” ì£¼ì†Œ(//) ë³´ì •
        if (url.startsWith('//')) {
            url = 'https:' + url;
        }

        // ì•„ì¹´ë¼ì´ë¸Œ, ë””ì‹œ ë“±ì€ í”„ë¡ì‹œ ì‚¬ìš©
        if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
            // n=-1 ì˜µì…˜: ì—ëŸ¬ ë°œìƒ ì‹œ ë¦¬ë‹¤ì´ë ‰íŠ¸ í•˜ì§€ ì•ŠìŒ
            return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
        }

        return url;
    }

    // ğŸš© [í•µì‹¬ 2] ì—ëŸ¬ ë°œìƒ ì‹œ ë¡œì»¬ ì´ë¯¸ì§€ë¡œ ëŒ€ì²´ (onerror ìˆ˜ì •)
    function createLinkCardInstant(data, container) {
        try {
            const domain = new URL(data.url).hostname;
            const safeImage = getProxyImage(data.image);

            const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>
                </a>`;
            container.insertAdjacentHTML('beforeend', html);
        } catch (e) {
            console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e);
        }
    }
</script>
</body>
</html>