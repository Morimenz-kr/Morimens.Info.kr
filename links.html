<!DOCTYPE html>
<html lang="ko">
<head>
    <link rel="icon" type="image/webp" href="images/smile_Ramona.webp">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ - ë§ê°ì „ì•¼</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://morimenz-kr.github.io/Morimens.Info.kr/">
    <meta property="og:title" content="ë§ê°ì „ì•¼ (Morimens) ì¢…í•© ê°€ì´ë“œ">
    <meta property="og:description" content="ìºë¦­í„° ê³µëµ, í™˜ëª½ì‹¬ì , ìœµì¬ê¸ˆêµ¬, ì¿ í° ë“± ë§ê°ì „ì•¼ì˜ ëª¨ë“  ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://morimenz-kr.github.io/Morimens.Info.kr/images/background.png">

    <link rel="stylesheet" href="css/index.css">
    <style>
        /* --- 1. ê³µí†µ ë ˆì´ì•„ì›ƒ --- */
        * { box-sizing: border-box; }

        /* ğŸ”¥ ë°°ê²½ìƒ‰: ì§™ì€ íšŒìƒ‰ (#1a1a1a) í†µì¼ */
        body {
            background-color: #1a1a1a;
            color: #ecf0f1;
            margin: 0; padding: 0;
            font-family: 'Arial', sans-serif;
        }

        .link-container { max-width: 800px; margin: 0 auto; padding: 20px; }

        .category-title {
            color: #ffc107; border-bottom: 2px solid #555; padding-bottom: 15px; margin-bottom: 30px;
            font-size: 1.8em; text-align: left; display: flex; align-items: center; gap: 10px;
        }

        .title-thumb {
            width: 50px; height: 50px; border-radius: 8px; object-fit: cover; border: 2px solid #555;
        }

        .no-data {
            text-align: center; padding: 50px; color: #777; border: 2px dashed #444; border-radius: 10px;
        }

        /* ì œë³´ ë²„íŠ¼ ì„¹ì…˜ */
        .report-section {
            margin-top: 40px; padding-top: 20px; border-top: 1px solid #444;
            text-align: center; color: #777; font-size: 0.9em;
        }

        .report-btn {
            display: inline-block; margin-top: 10px; padding: 8px 16px;
            background-color: #333; color: #ccc; text-decoration: none; border-radius: 20px;
            border: 1px solid #555; transition: all 0.2s; cursor: pointer;
        }
        .report-btn:hover { background-color: #444; color: #fff; border-color: #ffc107; }

        /* --- 2. ë§í¬ ì¹´ë“œ ìŠ¤íƒ€ì¼ (ëª¨ë°”ì¼ ìµœì í™”) --- */
        .notion-bookmark {
            display: flex; background-color: #2a2a2a; border: 1px solid #444; border-radius: 6px;
            text-decoration: none; color: #eee; margin-bottom: 16px; transition: all 0.2s;
            height: auto; /* ë†’ì´ ìë™ */
            min-height: 100px;
            overflow: hidden;
        }
        .notion-bookmark:hover { background-color: #353535; border-color: #888; transform: translateY(-2px); }

        .bookmark-content {
            flex: 1; padding: 12px 16px;
            display: flex; flex-direction: column; justify-content: space-between;
            min-width: 0;
        }

        .bookmark-title {
            font-size: 1.1em; font-weight: bold;
            white-space: normal;
            overflow: hidden; text-overflow: ellipsis;
            color: #fff; margin-bottom: 5px;
            line-height: 1.3;
        }

        .bookmark-desc {
            font-size: 0.9em; color: #aaa;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
            overflow: hidden; line-height: 1.3;
        }

        .bookmark-image {
            width: 120px; /* ì¸ë„¤ì¼ ë„ˆë¹„ */
            background-color: #111; flex-shrink: 0;
        }
        .bookmark-image img { width: 100%; height: 100%; object-fit: cover; }

        .bookmark-url {
            font-size: 0.75em; color: #666; margin-top: 8px;
            display: flex; align-items: center; gap: 5px;
        }

        /* --- 3. êµí™˜ ì½”ë“œ (í…ìŠ¤íŠ¸ ë°•ìŠ¤) ìŠ¤íƒ€ì¼ --- */
        .text-link-box {
            display: block;
            background-color: #2a2a2a;
            border: 1px solid #444;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            text-align: center;
            color: #bbb;
            font-size: 1.1em;
            line-height: 1.6;
        }

        .code-warning-text {
            font-size: 0.85em; color: #999; text-align: center;
            margin-bottom: 15px; padding: 8px 15px; background-color: #333; border-radius: 8px;
        }

        .code-line {
            padding: 10px; margin: 5px 0; border-bottom: 1px dashed #444;
            cursor: pointer; transition: all 0.2s ease; word-break: break-all;
        }
        .code-line:hover { background-color: rgba(255, 255, 255, 0.05); color: #fff; }
        .code-line:last-child { border-bottom: none; }

        /* ë³µì‚¬ ì™„ë£Œ í”¼ë“œë°± */
        .code-line.copied {
            color: #ffc107 !important; transform: scale(0.98); background-color: transparent;
        }

        /* --- 4. ì œë³´ ëª¨ë‹¬ í¼ ìŠ¤íƒ€ì¼ --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.85); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-overlay.show { display: flex; }

        .modal-content {
            width: 90%; max-width: 500px; background-color: #2c2c2c; border-radius: 12px;
            padding: 30px; box-shadow: 0 5px 25px rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { 0% {opacity: 0; transform: translateY(-20px);} 100% {opacity: 1; transform: translateY(0);} }

        .form-title { color: #ffc107; border-bottom: 2px solid #444; padding-bottom: 10px; margin-top: 0; }
        .form-field-label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: bold; color: #ccc; }

        .form-input, .form-textarea {
            width: 100%; padding: 12px; border: 1px solid #555; border-radius: 6px;
            background-color: #383838; color: #eee; font-size: 1em; box-sizing: border-box;
        }
        .form-textarea { min-height: 120px; resize: vertical; }

        .form-submit-btn {
            display: block; width: 100%; padding: 12px; margin-top: 20px;
            background-color: #007bff; color: white; border: none; border-radius: 6px;
            font-weight: bold; cursor: pointer; transition: background-color 0.2s;
        }
        .form-submit-btn:hover { background-color: #0056b3; }

        /* --- 5. ë°˜ì‘í˜• (ëª¨ë°”ì¼) --- */
        @media (max-width: 600px) {
            .bookmark-image { width: 100px; }
            .bookmark-content { padding: 10px 12px; }
            .bookmark-title { font-size: 1em; }
        }
    </style>
</head>
<body>

<div class="container" style="position: relative; z-index: 2;">
    <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

    <div class="link-container">
        <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
        <div id="links-list"></div>

        <div class="report-section">
            <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
            <a href="#" id="open-report-modal" class="report-btn">
                ğŸš¨ ë²„ê·¸/í”¼ë“œë°± ì œë³´í•˜ê¸°
            </a>
        </div>
    </div>
</div>

<div id="report-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="form-title">ğŸš¨ ë²„ê·¸ ì œë³´ or í”¼ë“œë°±</h2>
        <p style="color:#aaa; font-size:0.9em;">ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. ê°œë°œìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p>

        <form id="bug-report-form" action="https://discordapp.com/api/webhooks/1442726767222718554/i3QtvZ6-giYqwtlheMm3ugxcJoVsoVYmExBPX2n-uEoFHpWwmGqaaO_f6gnlBNXCZYas" method="POST">

            <label for="reporter-email" class="form-field-label">íŒ¨ì¹˜ë…¸íŠ¸ì— ì˜¬ë¼ê°ˆ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
            <input type="text" id="reporter-email" name="_replyto" class="form-input" placeholder="íŒ¨ì¹˜ë…¸íŠ¸ì— ì–¸ê¸‰ì„ ì›í•˜ì‹œë©´ ì ì–´ì£¼ì„¸ìš”.">

            <label for="report-message" class="form-field-label">ì œë³´í•  ë‚´ìš© (ë²„ê·¸ or í”¼ë“œë°±) (í•„ìˆ˜)</label>
            <textarea id="report-message" name="message" class="form-textarea" required
                      placeholder="ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>

            <input type="hidden" name="report_source_url" id="report-source-url">
            <input type="hidden" name="_subject" value="[Morimens Wiki] ë²„ê·¸/í”¼ë“œë°± ì ‘ìˆ˜">

            <button type="submit" class="form-submit-btn">ì œë³´ ë³´ë‚´ê¸°</button>
            <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">ì „ì†¡ ì¤‘...</p>
        </form>

    </div>
</div>

<script>
    // ğŸš© ì „ì—­ ë³µì‚¬ í•¨ìˆ˜
    function copyCodeToClipboard(text, element) {
        if (!navigator.clipboard) {
            alert("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            element.classList.add('copied');
            const originalText = element.innerHTML;
            element.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
            setTimeout(() => {
                element.classList.remove('copied');
                element.innerHTML = originalText;
            }, 800);
        }).catch(err => {
            console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
            alert('ë³µì‚¬ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const category = urlParams.get('category');
        const charId = urlParams.get('id');
        const titleEl = document.getElementById('page-title');
        const listEl = document.getElementById('links-list');
        const modal = document.getElementById('report-modal');
        const openModalBtn = document.getElementById('open-report-modal');
        const sourceUrlInput = document.getElementById('report-source-url');
        const reportForm = document.getElementById('bug-report-form');
        const modalStatus = document.getElementById('modal-form-status');

        try {
            const ts = new Date().getTime();
            const [manifestRes, linksRes] = await Promise.all([
                fetch(`data/character_manifest.json?t=${ts}`),
                fetch(`data/resource_links.json?t=${ts}`)
            ]);

            if(!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

            const manifest = await manifestRes.json();
            const linksDB = await linksRes.json();
            let targetItems = [];
            let pageTitleHTML = "";

            if (category === 'character' && charId) {
                const charData = manifest.find(c => String(c.id) === String(charId));
                if (charData) {
                    pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                    targetItems = linksDB.characters[charId] || [];
                } else { pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°"; }
            } else if (category && linksDB.categories[category]) {
                pageTitleHTML = linksDB.categories[category].title;
                targetItems = linksDB.categories[category].links || [];
            } else { pageTitleHTML = "ì˜ëª»ëœ ì ‘ê·¼"; }

            titleEl.innerHTML = pageTitleHTML;
            listEl.innerHTML = '';

            if (targetItems.length === 0) {
                listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
            }

            // ë Œë”ë§ ë¶„ê¸°
            if (category === 'code') {
                renderCodeLinks(targetItems, listEl);
            } else {
                targetItems.forEach(item => {
                    if (typeof item === 'string') {
                        createLinkCardFromAPI(item, listEl);
                    } else {
                        createLinkCardInstant(item, listEl);
                    }
                });
            }

        } catch (error) {
            console.error(error);
            titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
            listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
        }

        // íŒì—… ë¡œì§
        if(openModalBtn) {
            openModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                modal.classList.add('show');
                sourceUrlInput.value = window.location.href;
            });
        }
        if(modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('show');
            });
        }
        if(reportForm) {
            reportForm.addEventListener("submit", async (e) => {
                e.preventDefault();
                modalStatus.style.display = 'block';
                modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';

                const data = new FormData(e.target);
                const reporterEmail = data.get('_replyto') || 'N/A';
                const message = data.get('message');
                const sourceUrl = data.get('report_source_url');
                const DISCORD_ENDPOINT = e.target.action;

                const payload = {
                    username: "Morimens Wiki Reporter",
                    embeds: [{
                        title: "ğŸš¨ ì‹ ê·œ ê¹¨ì§„ ë§í¬ ì œë³´ ì ‘ìˆ˜",
                        color: 15777040,
                        fields: [
                            { name: "ì œë³´ì ì´ë©”ì¼", value: reporterEmail, inline: false },
                            { name: "ì œë³´ í˜ì´ì§€", value: `[ë§í¬](${sourceUrl})`, inline: false },
                            { name: "ìƒì„¸ ë‚´ìš©", value: message, inline: false },
                        ],
                        timestamp: new Date().toISOString()
                    }]
                };

                try {
                    const response = await fetch(DISCORD_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        modalStatus.textContent = "âœ… ì œë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.";
                        reportForm.reset();
                        setTimeout(() => modal.classList.remove('show'), 3000);
                    } else {
                        modalStatus.textContent = `âŒ ì „ì†¡ ì‹¤íŒ¨: Webhook ì˜¤ë¥˜ (ìƒíƒœ ì½”ë“œ: ${response.status})`;
                    }
                } catch (error) {
                    modalStatus.textContent = "âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                }
            });
        }
    });

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
    function getProxyImage(url) {
        if (!url) return 'images/smile_Ramona.webp';
        url = url.trim();
        if (url.startsWith('//')) { url = 'https:' + url; }
        if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
            return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
        }
        return url;
    }

    async function renderCodeLinks(urls, container) {
        const warningHtml = '<div class="code-warning-text">ë§Œë£Œëœ êµí™˜ ì½”ë“œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
        container.insertAdjacentHTML('beforebegin', warningHtml);
        const codeBox = document.createElement('div');
        codeBox.className = 'text-link-box';
        let codeContentHTML = '';

        urls.forEach(item => {
            let codeLine = '', codeString = '';
            if (typeof item === 'object') {
                codeLine = `<b>${item.title}</b>: ${item.desc || item.url || ''}`;
                codeString = item.desc || item.title;
            } else {
                codeLine = item;
                codeString = item;
            }
            const cleanedCode = codeString.replace(/\n/g, ' ').trim();
            codeContentHTML += `<div class="code-line" onclick="copyCodeToClipboard('${cleanedCode}', this)">${codeLine}</div>`;
        });
        codeBox.innerHTML = codeContentHTML;
        container.appendChild(codeBox);
    }

    function createLinkCardInstant(data, container) {
        try {
            const domain = new URL(data.url).hostname;
            const safeImage = getProxyImage(data.image);
            const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>
                </a>`;
            container.insertAdjacentHTML('beforeend', html);
        } catch (e) { console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e); }
    }

    async function createLinkCardFromAPI(url, container) {
        const cardWrap = document.createElement('div');
        cardWrap.className = 'skeleton skeleton-card';
        cardWrap.innerHTML = `<div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div>`;
        container.appendChild(cardWrap);
        try {
            const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
            const res = await fetch(apiUrl);
            const json = await res.json();
            if (json.status === 'success') {
                const data = json.data;
                const safeImage = getProxyImage(data.image?.url);
                cardWrap.className = 'notion-bookmark';
                cardWrap.innerHTML = '';
                const linkEl = document.createElement('a');
                linkEl.href = url; linkEl.target = "_blank";
                linkEl.className = "notion-bookmark"; linkEl.style.width = "100%";
                linkEl.innerHTML = `
                    <div class="bookmark-content">
                        <div><div class="bookmark-title">${data.title || url}</div><div class="bookmark-desc">${data.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div></div>
                        <div class="bookmark-url">ğŸ”— ${data.publisher || 'Link'}</div>
                    </div>
                    <div class="bookmark-image"><img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" onerror="this.onerror=null; this.src='images/smile_Ramona.webp';"></div>`;
                container.replaceChild(linkEl, cardWrap);
            } else { throw new Error("API Fail"); }
        } catch (e) {
            cardWrap.className = 'notion-bookmark';
            cardWrap.innerHTML = `<a href="${url}" target="_blank" style="padding:20px; color:#fff; text-decoration:none; width:100%; display:block;"><div style="font-weight:bold; margin-bottom:5px;">${url}</div><div style="font-size:0.8em; color:#aaa;">(ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ - ì½˜ì†” í™•ì¸)</div></a>`;
        }
    }
</script>
</body>
</html>