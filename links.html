<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="icon" type="image/webp" href="images/smile_Ramona.webp">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì •ë³´ ëª¨ìŒ</title>

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://morimenz-kr.github.io/Morimens.Info.kr/">
    <meta property="og:title" content="ë¯¸ì‚¬ê·¸ ëŒ€í•™ í•œêµ­ ìº í¼ìŠ¤">
    <meta property="og:description" content="ìºë¦­í„° ê³µëµ, í™˜ëª½ì‹¬ì , ìœµì¬ê¸ˆêµ¬, ì¿ í° ë“± ë¯¸ì‚¬ê·¸ ëŒ€í•™ì˜ ëª¨ë“  ì •ë³´ë¥¼ í•œëˆˆì— í™•ì¸í•˜ì„¸ìš”.">
    <meta property="og:image" content="https://morimenz-kr.github.io/Morimens.Info.kr/images/background.png">

    <!-- CSS íŒŒì¼ ì—°ê²° -->
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages/links.css">
    <link rel="stylesheet" href="css/responsive.css">
    <!-- Config íŒŒì¼ ë¡œë“œ -->
    <script src="config/config.js"></script>
</head>

<body>

    <div class="container" style="position: relative; z-index: 2;">
        <a href="javascript:history.back()" class="back-link">â¬… ë’¤ë¡œê°€ê¸°</a>

        <div class="link-container">
            <h2 id="page-title" class="category-title">ë°ì´í„° ë¡œë”© ì¤‘...</h2>
            <div id="links-list"></div>

            <div class="report-section">
                <p>í˜¹ì‹œ ì—°ê²°ë˜ì§€ ì•ŠëŠ” ë§í¬ê°€ ìˆë‚˜ìš”?</p>
                <a href="#" id="open-report-modal" class="report-btn">
                    ğŸš¨ ë²„ê·¸/í”¼ë“œë°± ì œë³´í•˜ê¸°
                </a>
            </div>
        </div>
    </div>

    <div id="report-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 class="form-title">ğŸš¨ ë²„ê·¸ ì œë³´ or í”¼ë“œë°±</h2>
            <p style="color:#aaa; font-size:0.9em;">ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”. ê°œë°œìì—ê²Œ ì¦‰ì‹œ ì•Œë¦¼ì´ ì „ì†¡ë©ë‹ˆë‹¤.</p>

            <form id="bug-report-form" action="javascript:void(0);" onsubmit="sendToDiscord(event)" method="POST">

                <label for="reporter-email" class="form-field-label">íŒ¨ì¹˜ë…¸íŠ¸ì— ì˜¬ë¼ê°ˆ ë‹‰ë„¤ì„ (ì„ íƒ)</label>
                <input type="text" id="reporter-email" name="_replyto" class="form-input"
                    placeholder="íŒ¨ì¹˜ë…¸íŠ¸ì— ì–¸ê¸‰ì„ ì›í•˜ì‹œë©´ ì ì–´ì£¼ì„¸ìš”.">

                <label for="report-message" class="form-field-label">ì œë³´í•  ë‚´ìš© (ë²„ê·¸ or í”¼ë“œë°±) (í•„ìˆ˜)</label>
                <textarea id="report-message" name="message" class="form-textarea" required
                    placeholder="ì œë³´í•˜ì‹¤ ë‚´ìš©ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>

                <input type="hidden" name="report_source_url" id="report-source-url">
                <input type="hidden" name="_subject" value="[Morimens Wiki] ë²„ê·¸/í”¼ë“œë°± ì ‘ìˆ˜">

                <button type="submit" class="form-submit-btn">ì œë³´ ë³´ë‚´ê¸°</button>
                <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">ì „ì†¡
                    ì¤‘...</p>
            </form>

        </div>
    </div>

    <script>
        // ğŸš© ì „ì—­ ë³µì‚¬ í•¨ìˆ˜ (êµí™˜ ì½”ë“œ ë“±ì—ì„œ ì‚¬ìš©)
        function copyCodeToClipboard(text, element) {
            if (!navigator.clipboard) {
                alert("âš ï¸ ì´ ë¸Œë¼ìš°ì €ëŠ” í´ë¦½ë³´ë“œ ë³µì‚¬ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                element.classList.add('copied');
                const originalText = element.innerHTML;
                element.innerHTML = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
                setTimeout(() => {
                    element.classList.remove('copied');
                    element.innerHTML = originalText;
                }, 800);
            }).catch(err => {
                console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const category = urlParams.get('category');
            const charId = urlParams.get('id');
            const titleEl = document.getElementById('page-title');
            const listEl = document.getElementById('links-list');

            // ëª¨ë‹¬ ê´€ë ¨ ìš”ì†Œ
            const modal = document.getElementById('report-modal');
            const openModalBtn = document.getElementById('open-report-modal');
            const sourceUrlInput = document.getElementById('report-source-url');

            // 1. ì¹´í…Œê³ ë¦¬ë³„ í´ë˜ìŠ¤ ì¶”ê°€ (CSS ìŠ¤íƒ€ì¼ë§ ìš©ì´ì„± í™•ë³´)
            if (category) {
                document.body.classList.add(`category-${category}`);
            }

            try {
                // ìºì‹± ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„
                const ts = new Date().getTime();
                const [manifestRes, linksRes] = await Promise.all([
                    fetch(`data/character_manifest.json?t=${ts}`),
                    fetch(`data/resource_links.json?t=${ts}`)
                ]);

                if (!manifestRes.ok || !linksRes.ok) throw new Error("JSON íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨");

                const manifest = await manifestRes.json();
                const linksDB = await linksRes.json();
                let targetItems = [];
                let pageTitleHTML = "";

                // 2. ë°ì´í„° ë¡œë“œ ë¶„ê¸° ì²˜ë¦¬
                if (category === 'character' && charId) {
                    const charData = manifest.find(c => String(c.id) === String(charId));
                    if (charData) {
                        pageTitleHTML = `<img src="${charData.image_thumb}" class="title-thumb" alt=""> ${charData.name} ê³µëµ ëª¨ìŒ`;
                        targetItems = linksDB.characters[charId] || [];
                    } else {
                        pageTitleHTML = "ì•Œ ìˆ˜ ì—†ëŠ” ìºë¦­í„°";
                    }
                } else if (category && linksDB.categories[category]) {
                    // event, weekly_yungjae ë“± ëª¨ë“  ì¹´í…Œê³ ë¦¬ ì²˜ë¦¬
                    pageTitleHTML = linksDB.categories[category].title;
                    targetItems = linksDB.categories[category].links || [];
                } else {
                    pageTitleHTML = "ì¡´ì¬í•˜ì§€ ì•ŠëŠ” í˜ì´ì§€";
                    targetItems = [];
                }

                titleEl.innerHTML = pageTitleHTML;
                listEl.innerHTML = '';

                if (targetItems.length === 0) {
                    listEl.innerHTML = `<div class="no-data"><p>ğŸ“­</p><p>ì•„ì§ ë“±ë¡ëœ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                }

                // 3. ë Œë”ë§ ë¶„ê¸°
                if (category === 'code') {
                    renderCodeLinks(targetItems, listEl);
                } else {
                    targetItems.forEach(item => {
                        // ë¬¸ìì—´ì¸ ê²½ìš°(URLë§Œ ìˆëŠ” ê²½ìš°)ì™€ ê°ì²´ì¸ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
                        if (typeof item === 'string') {
                            createLinkCardFromAPI(item, listEl);
                        } else {
                            createLinkCardInstant(item, listEl);
                        }
                    });
                }

            } catch (error) {
                console.error(error);
                titleEl.textContent = "ì˜¤ë¥˜ ë°œìƒ";
                listEl.innerHTML = `<p style="text-align:center;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.<br><small>${error.message}</small></p>`;
            }

            // 4. ëª¨ë‹¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            if (openModalBtn) {
                openModalBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    modal.classList.add('show');
                    if(sourceUrlInput) sourceUrlInput.value = window.location.href;
                });
            }
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('show');
                });
            }
        });

        // --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

        // ì´ë¯¸ì§€ í”„ë¡ì‹œ (ì™¸ë¶€ ì´ë¯¸ì§€ ë¡œë”© ë¬¸ì œ í•´ê²°)
        function getProxyImage(url) {
            if (!url) return 'images/smile_Ramona.webp';
            url = url.trim();
            if (url.startsWith('//')) { url = 'https:' + url; }
            // ë‚˜ë¬´ìœ„í‚¤/ì•„ì¹´ë¼ì´ë¸Œ/ë””ì‹œ ì´ë¯¸ì§€ëŠ” ë¦¬í¼ëŸ¬ ë¬¸ì œë¡œ ë¡œë”© ì•ˆ ë  ìˆ˜ ìˆì–´ í”„ë¡ì‹œ ì‚¬ìš©
            if (url.includes('namu.la') || url.includes('arca.live') || url.includes('dcinside')) {
                return `https://images.weserv.nl/?url=${encodeURIComponent(url)}&w=400&output=webp&n=-1`;
            }
            return url;
        }

        // êµí™˜ ì½”ë“œ ë Œë”ë§
        async function renderCodeLinks(urls, container) {
            const warningHtml = '<div class="code-warning-text">ë§Œë£Œëœ êµí™˜ ì½”ë“œê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
            container.insertAdjacentHTML('beforebegin', warningHtml);
            const codeBox = document.createElement('div');
            codeBox.className = 'text-link-box';
            let codeContentHTML = '';

            urls.forEach(item => {
                let codeLine = '', codeString = '';
                if (typeof item === 'object') {
                    codeLine = `<b>${item.title}</b>: ${item.desc || item.url || ''}`;
                    codeString = item.desc || item.title;
                } else {
                    codeLine = item;
                    codeString = item;
                }
                const cleanedCode = codeString.replace(/\\n/g, ' ').trim();
                codeContentHTML += `<div class="code-line" onclick="copyCodeToClipboard('${cleanedCode}', this)">${codeLine}</div>`;
            });
            codeBox.innerHTML = codeContentHTML;
            container.appendChild(codeBox);
        }

        // ì¦‰ì‹œ ì¹´ë“œ ìƒì„± (JSONì— ë°ì´í„°ê°€ ë‹¤ ìˆëŠ” ê²½ìš°) - ëª¨ë°”ì¼ ë°˜ì‘í˜• ê³ ë ¤
        function createLinkCardInstant(data, container) {
            try {
                // ë„ë©”ì¸ ì¶”ì¶œ (urlì´ ì—†ì„ ê²½ìš° ì˜ˆì™¸ ì²˜ë¦¬)
                let domain = 'link';
                try {
                    if(data.url) domain = new URL(data.url).hostname;
                } catch(e) {}

                const safeImage = getProxyImage(data.image);

                // HTML êµ¬ì¡°: CSS(notion-bookmark)ê°€ ëª¨ë°”ì¼ì—ì„œ flex-direction: column ì²˜ë¦¬í•œë‹¤ê³  ê°€ì •
                const html = `
                <a href="${data.url}" target="_blank" class="notion-bookmark">
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title || 'ì œëª© ì—†ìŒ'}</div>
                            <div class="bookmark-desc">${data.desc || ''}</div>
                        </div>
                        <div class="bookmark-url">
                            <img src="https://www.google.com/s2/favicons?domain=${domain}" width="14" height="14" style="margin-right:4px; vertical-align:middle;">
                            ${domain}
                        </div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" 
                             onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>
                </a>`;
                container.insertAdjacentHTML('beforeend', html);
            } catch (e) { console.error("ì¹´ë“œ ìƒì„± ì—ëŸ¬:", e); }
        }

        // APIë¡œ ë©”íƒ€ë°ì´í„° ê¸ì–´ì˜¤ê¸° (URLë§Œ ìˆëŠ” ê²½ìš°)
        async function createLinkCardFromAPI(url, container) {
            const cardWrap = document.createElement('div');
            // ìŠ¤ì¼ˆë ˆí†¤ ë¡œë”© UI
            cardWrap.className = 'skeleton skeleton-card';
            cardWrap.innerHTML = `<div class="skeleton-content"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-desc"></div></div><div class="skeleton skeleton-img"></div>`;
            container.appendChild(cardWrap);
            try {
                const apiUrl = `https://api.microlink.io?url=${encodeURIComponent(url)}`;
                const res = await fetch(apiUrl);
                const json = await res.json();

                if (json.status === 'success') {
                    const data = json.data;
                    const safeImage = getProxyImage(data.image?.url);

                    // ìŠ¤ì¼ˆë ˆí†¤ ì œê±° í›„ ì‹¤ì œ ì¹´ë“œ ì ìš©
                    cardWrap.className = 'notion-bookmark'; // CSS í´ë˜ìŠ¤ ë³€ê²½
                    cardWrap.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ë¹„ì›€

                    const linkEl = document.createElement('a');
                    linkEl.href = url;
                    linkEl.target = "_blank";
                    linkEl.className = "notion-bookmark";
                    linkEl.style.width = "100%"; // ëª¨ë°”ì¼ ê½‰ ì°¸ ë³´ì¥

                    linkEl.innerHTML = `
                    <div class="bookmark-content">
                        <div>
                            <div class="bookmark-title">${data.title || url}</div>
                            <div class="bookmark-desc">${data.description || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        </div>
                        <div class="bookmark-url">ğŸ”— ${data.publisher || 'Link'}</div>
                    </div>
                    <div class="bookmark-image">
                        <img src="${safeImage}" alt="ì¸ë„¤ì¼" loading="lazy" onerror="this.onerror=null; this.src='images/smile_Ramona.webp';">
                    </div>`;

                    container.replaceChild(linkEl, cardWrap);
                } else { throw new Error("API Fail"); }
            } catch (e) {
                // ì‹¤íŒ¨ ì‹œ í…ìŠ¤íŠ¸ ë§í¬ë¡œ ëŒ€ì²´
                cardWrap.className = 'notion-bookmark';
                cardWrap.innerHTML = `<a href="${url}" target="_blank" style="padding:15px; color:#fff; text-decoration:none; width:100%; display:block;"><div style="font-weight:bold; margin-bottom:5px; word-break:break-all;">${url}</div><div style="font-size:0.8em; color:#aaa;">(ë¯¸ë¦¬ë³´ê¸° ë¡œë“œ ì‹¤íŒ¨)</div></a>`;
            }
        }

        // Discord Webhook ì „ì†¡ í•¨ìˆ˜ (HTMLì˜ onsubmit ì†ì„±ì—ì„œ í˜¸ì¶œë¨)
        async function sendToDiscord(event) {
            event.preventDefault(); // í¼ ê¸°ë³¸ ì œì¶œ ë§‰ê¸°

            const form = event.target;
            const formData = new FormData(form);
            const modalStatus = document.getElementById('modal-form-status');
            const modal = document.getElementById('report-modal');

            if (modalStatus) {
                modalStatus.style.display = 'block';
                modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';
            }

            const reporterEmail = formData.get('_replyto') || 'N/A';
            const message = formData.get('message');
            const sourceUrl = formData.get('report_source_url') || window.location.href;

            const payload = {
                username: "Morimens Wiki Reporter",
                embeds: [{
                    title: "ğŸš¨ ì‹ ê·œ ë²„ê·¸/í”¼ë“œë°± ì œë³´ ì ‘ìˆ˜",
                    color: 15777040,
                    fields: [
                        { name: "ì œë³´ì ë‹‰ë„¤ì„", value: reporterEmail, inline: false },
                        { name: "ì œë³´ í˜ì´ì§€", value: `[ë§í¬](${sourceUrl})`, inline: false },
                        { name: "ìƒì„¸ ë‚´ìš©", value: message, inline: false },
                    ],
                    timestamp: new Date().toISOString()
                }]
            };

            try {
                // Config íŒŒì¼ì—ì„œ URL ê°€ì ¸ì˜¤ê¸°
                const response = await fetch(CONFIG.DISCORD_WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Discord Webhookì€ ì„±ê³µ ì‹œ 204 No Contentë¥¼ ë°˜í™˜í•˜ë¯€ë¡œ response.ok ì²´í¬ê°€ ì• ë§¤í•  ìˆ˜ ìˆìœ¼ë‚˜
                // fetchê°€ ì˜ˆì™¸ ì—†ì´ ì™„ë£Œë˜ë©´ ì „ì†¡ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
                if (modalStatus) {
                    modalStatus.textContent = "âœ… ì œë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! ê°ì‚¬í•©ë‹ˆë‹¤.";
                }
                form.reset();

                // ì„±ê³µ ë©”ì‹œì§€ë¥¼ 1.5ì´ˆ ë™ì•ˆ ë³´ì—¬ì¤€ í›„ ëª¨ë‹¬ ë‹«ê¸°
                setTimeout(() => {
                    modal.classList.remove('show');
                    if (modalStatus) {
                        modalStatus.style.display = 'none';
                        modalStatus.textContent = 'ì œë³´ë¥¼ ì „ì†¡ ì¤‘ì…ë‹ˆë‹¤...';
                    }
                }, 1500);
            } catch (error) {
                console.error(error);
                if (modalStatus) {
                    modalStatus.textContent = 'âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                }
            }
        }
    </script>

    <!-- Floating ì‹ ê³  ë²„íŠ¼ -->
    <button class="floating-report-btn" onclick="openReportModal()" title="ë²„ê·¸ ì‹ ê³ ">
        ğŸš¨
    </button>
</body>

</html>