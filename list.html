<!DOCTYPE html>
<html lang="ko">

<head>
    <link rel="icon" type="image/webp" href="images/smile_Ramona.webp">
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>각성체 목록</title>

    <script src="config/config.js"></script>
    <script>
        loadCSS('css/common.css');
        loadCSS('css/components.css');
        loadCSS('css/pages/list.css');
        loadCSS('css/responsive.css');
    </script>
</head>

<body>
<div class="container">

    <div class="header-area">
        <a href="index.html" class="back-link">⬅ 돌아가기</a>
        <h1>각성체 목록</h1>
    </div>

    <div class="controls-container">
        <input type="search" id="search-bar" class="search-bar" placeholder="캐릭터 이름 검색...">
        <div class="filter-container">
            <select id="relems-filter">
                <option value="all">계역 (전체)</option>
                <option value="chaos">혼돈</option>
                <option value="aequor">심해</option>
                <option value="caro">혈육</option>
                <option value="ultra">초차원</option>
            </select>
            <select id="grade-filter">
                <option value="all">등급 (전체)</option>
                <option value="ssr">SSR</option>
                <option value="sr">SR</option>
            </select>
            <select id="class-filter">
                <option value="all">클래스 (전체)</option>
                <option value="assault">데미지</option>
                <option value="warden">방어</option>
                <option value="chorus">보조</option>
            </select>
        </div>
    </div>

    <div class="character-grid" id="character-grid">
    </div>
</div>

<script src="js/index.js"></script>

<div id="report-modal" class="modal-overlay">
    <div class="modal-content">
        <h2 class="form-title">🚨 버그 제보 or 피드백</h2>
        <p style="color:#aaa; font-size:0.9em;">제보하실 내용을 적어주세요. 개발자에게 즉시 알림이 전송됩니다.</p>

        <form id="bug-report-form" action="javascript:void(0);" onsubmit="sendToDiscord(event)" method="POST">

            <label for="reporter-email" class="form-field-label">패치노트에 올라갈 닉네임 (선택)</label>
            <input type="text" id="reporter-email" name="_replyto" class="form-input"
                   placeholder="패치노트에 언급을 원하시면 적어주세요.">

            <label for="report-message" class="form-field-label">
                제보할 내용 (버그 or 피드백) (필수)
                <span style="display:block; margin-top:5px; font-size:0.9em; color:#ff9f43; font-weight:normal;">
                        ※ 특정 게시글/정보 관련 제보라면, <u>해당 글의 링크</u>를 본문에 꼭 적어주세요!
                    </span>
            </label>
            <textarea id="report-message" name="message" class="form-textarea" required
                      placeholder="내용을 입력해주세요. (예: 'XX 캐릭터 스킬 설명 오타', '이 링크(URL) 접속이 안 돼요')"></textarea>

            <input type="hidden" name="report_source_url" id="report-source-url">

            <button type="submit" class="form-submit-btn">제보 보내기</button>
            <p id="modal-form-status" style="margin-top: 15px; color:#ffc107; text-align:center; display: none;">전송 중...</p>
        </form>
    </div>
</div>

<script>
    // 1. 모달 열기 함수
    function openReportModal() {
        const modal = document.getElementById('report-modal');
        const sourceUrlInput = document.getElementById('report-source-url');
        const modalStatus = document.getElementById('modal-form-status');

        if (modalStatus) {
            modalStatus.style.display = 'none';
            modalStatus.textContent = '제보를 전송 중입니다...';
            modalStatus.style.color = '#ffc107';
        }

        if (sourceUrlInput) {
            sourceUrlInput.value = window.location.href;
        }

        modal.classList.add('show');
    }

    // 2. 모달 닫기 이벤트
    document.addEventListener('DOMContentLoaded', () => {
        const reportModal = document.getElementById('report-modal');
        if (reportModal) {
            reportModal.addEventListener('click', (e) => {
                if (e.target === reportModal) {
                    reportModal.classList.remove('show');
                }
            });
        }
    });

    // 3. 디스코드 전송 로직
    async function sendToDiscord(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const modalStatus = document.getElementById('modal-form-status');
        const modal = document.getElementById('report-modal');

        if (modalStatus) {
            modalStatus.style.display = 'block';
            modalStatus.textContent = '제보를 전송 중입니다...';
            modalStatus.style.color = '#ffc107';
        }

        const reporterEmail = formData.get('_replyto') || '익명(Anonymous)';
        const message = formData.get('message');
        const sourceUrl = formData.get('report_source_url') || window.location.href;

        const payload = {
            username: "Morimens Wiki Bot",
            embeds: [{
                title: "📩 새로운 제보가 도착했습니다!",
                description: "위키에서 유저 피드백/버그 제보가 접수되었습니다.",
                color: 0xFF9F43,
                fields: [
                    { name: "👤 제보자", value: `\`${reporterEmail}\``, inline: true },
                    { name: "📍 발생 페이지", value: `[바로가기(Click)](${sourceUrl})`, inline: true },
                    { name: "📝 상세 내용", value: `>>> ${message}`, inline: false }
                ],
                footer: { text: "Morimens Wiki Report System" },
                timestamp: new Date().toISOString()
            }]
        };

        try {
            const webhookUrl = (typeof CONFIG !== 'undefined') ? CONFIG.DISCORD_WEBHOOK_URL : '';
            if(!webhookUrl) throw new Error("Config Error");

            await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (modalStatus) {
                modalStatus.textContent = "✅ 전송 완료! 감사합니다.";
                modalStatus.style.color = "#2ecc71";
            }
            form.reset();
            setTimeout(() => {
                modal.classList.remove('show');
                if (modalStatus) {
                    modalStatus.style.display = 'none';
                    modalStatus.textContent = '전송 중...';
                }
            }, 1500);
        } catch (error) {
            console.error(error);
            if (modalStatus) {
                modalStatus.textContent = '❌ 설정 오류 또는 네트워크 오류입니다.';
                modalStatus.style.color = "#e74c3c";
            }
        }
    }
</script>
<button class="floating-report-btn" onclick="openReportModal()" title="버그 신고">
    🚨
</button>
</body>
</html>